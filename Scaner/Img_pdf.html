<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mejorador de Documentos Escaneados</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(to right, #1e3c72, #2a5298);
            color: white;
            padding: 25px;
            text-align: center;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .config-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .config-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .config-btn {
            background: white;
            border: 2px solid #1e3c72;
            color: #1e3c72;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .config-btn.active {
            background: #1e3c72;
            color: white;
        }

        .upload-section {
            background-color: #f8f9fa;
            border: 2px dashed #1e3c72;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            background-color: #eef2ff;
            border-color: #2a5298;
        }

        .upload-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .upload-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .upload-option:hover {
            border-color: #1e3c72;
            background: #f8f9fa;
        }

        .upload-option-icon {
            font-size: 40px;
            color: #1e3c72;
        }

        .upload-option-text {
            font-weight: 600;
            color: #1e3c72;
            text-align: center;
        }

        .upload-icon {
            font-size: 50px;
            color: #1e3c72;
            margin-bottom: 15px;
        }

        .upload-text {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(to right, #1e3c72, #2a5298);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 0.95rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(30, 60, 114, 0.3);
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 60, 114, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-success {
            background: linear-gradient(to right, #11998e, #38ef7d);
        }

        .btn-warning {
            background: linear-gradient(to right, #f46b45, #eea849);
        }

        .btn-danger {
            background: linear-gradient(to right, #ff416c, #ff4b2b);
        }

        .btn-info {
            background: linear-gradient(to right, #007bff, #0056b3);
        }

        .btn-secondary {
            background: linear-gradient(to right, #6c757d, #495057);
        }

        .preview-section {
            display: none;
        }

        .preview-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #1e3c72;
            text-align: center;
        }

        .image-comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .comparison-box {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            background: white;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .comparison-header {
            background: #f8f9fa;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            border-bottom: 1px solid #eee;
            font-size: 1rem;
        }

        .comparison-image-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            min-height: 400px;
        }

        .comparison-image {
            width: 100%;
            height: 100%;
            max-height: 500px;
            object-fit: contain;
            display: block;
            padding: 10px;
        }

        .tools-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .filters-panel, .crop-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .panel-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #1e3c72;
            text-align: center;
        }

        .filter-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .filter-btn {
            background: white;
            border: 2px solid #1e3c72;
            color: #1e3c72;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-align: center;
        }

        .filter-btn:hover {
            background: #1e3c72;
            color: white;
        }

        .filter-btn.active {
            background: #1e3c72;
            color: white;
        }

        .crop-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .rotation-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .info-section {
            background-color: #eef2ff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .info-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #1e3c72;
        }

        .info-list {
            padding-left: 20px;
        }

        .info-list li {
            margin-bottom: 8px;
        }

        footer {
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
        }

        @media (max-width: 768px) {
            .image-comparison-container, .tools-section {
                grid-template-columns: 1fr;
            }
            
            .filter-buttons {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }

            .upload-options {
                flex-direction: column;
                align-items: center;
            }
        }

        /* Estilos para el recorte */
        .crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            cursor: crosshair;
            display: none;
            background: rgba(0,0,0,0.3);
        }

        .crop-area {
            position: absolute;
            border: 2px solid #ff0000;
            background: rgba(255, 0, 0, 0.1);
            cursor: move;
            box-sizing: border-box;
        }

        .crop-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ff0000;
            border: 2px solid white;
            border-radius: 50%;
        }

        .handle-tl { top: -6px; left: -6px; cursor: nw-resize; }
        .handle-tr { top: -6px; right: -6px; cursor: ne-resize; }
        .handle-bl { bottom: -6px; left: -6px; cursor: sw-resize; }
        .handle-br { bottom: -6px; right: -6px; cursor: se-resize; }

        .image-counter {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        .navigation-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        .crop-instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9rem;
            color: #856404;
        }

        .quality-control {
            margin-top: 15px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
        }

        .quality-slider {
            width: 100%;
            margin: 10px 0;
        }

        /* Estilos para la cámara */
        .camera-modal, .scanner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .camera-container, .scanner-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            position: relative;
            width: 500px;
        }

        .camera-preview {
            width: 100%;
            max-width: 640px;
            border-radius: 10px;
            background: #000;
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }

        .close-camera, .close-scanner {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .camera-flash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .flash-active {
            opacity: 0.8;
        }

        /* Estilos para el escáner */
        .scanner-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }

        .scanner-option {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .scanner-option:hover {
            border-color: #1e3c72;
            background: #f8f9fa;
        }

        .scanner-option-title {
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 5px;
        }

        .scanner-option-desc {
            font-size: 0.9rem;
            color: #666;
        }

        .scanner-instructions {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
        }

        .scanner-status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: #e2e3e5;
        }

        .printer-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }

        .printer-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .printer-item:hover {
            background: #f8f9fa;
        }

        .printer-item.selected {
            background: #1e3c72;
            color: white;
        }

        .printer-name {
            font-weight: bold;
        }

        .printer-details {
            font-size: 0.8rem;
            color: #666;
        }

        .printer-item.selected .printer-details {
            color: #ccc;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1e3c72;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pdf-quality {
            margin-top: 10px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
        }

        .quality-options {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .quality-option {
            flex: 1;
            padding: 8px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
        }

        .quality-option.selected {
            border-color: #1e3c72;
            background: #1e3c72;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Mejorador de Documentos Escaneados</h1>
            <p class="subtitle">Alta calidad PDF, cámara, escáner de impresora y filtros mejorados</p>
        </header>
        
        <div class="main-content">
            <!-- Sección de configuración -->
            <div class="config-section" id="configSection">
                <h3>Configuración del PDF</h3>
                <p>Selecciona cómo quieres organizar las imágenes en el PDF:</p>
                <div class="config-options">
                    <button class="config-btn active" id="onePerPage">1 Imagen por Página</button>
                    <button class="config-btn" id="twoPerPage">2 Imágenes por Página</button>
                </div>

                <div class="pdf-quality">
                    <label>Calidad del PDF:</label>
                    <div class="quality-options">
                        <div class="quality-option selected" data-quality="high">Alta Calidad</div>
                        <div class="quality-option" data-quality="medium">Calidad Media</div>
                        <div class="quality-option" data-quality="low">Tamaño Pequeño</div>
                    </div>
                </div>
            </div>

            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">📄</div>
                <h2 class="upload-text">Sube o captura tus documentos</h2>
                <p>Múltiples formas de obtener tus imágenes - Máximo 10 imágenes</p>
                
                <div class="upload-options">
                    <div class="upload-option" id="fileUploadOption">
                        <div class="upload-option-icon">📁</div>
                        <div class="upload-option-text">Subir Archivos</div>
                    </div>
                    <div class="upload-option" id="cameraOption">
                        <div class="upload-option-icon">📷</div>
                        <div class="upload-option-text">Tomar Foto</div>
                    </div>
                    <div class="upload-option" id="scannerOption">
                        <div class="upload-option-icon">🖨️</div>
                        <div class="upload-option-text">Escáner de Impresora</div>
                    </div>
                </div>
                
                <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>
                <button class="btn" id="selectBtn" style="display: none;">Seleccionar Imágenes</button>
            </div>
            
            <div class="preview-section" id="previewSection">
                <h2 class="preview-title">Mejora tus Documentos</h2>
                
                <div class="navigation-buttons">
                    <button class="btn" id="prevBtn">← Anterior</button>
                    <span id="imageCounter">Imagen 1 de 1</span>
                    <button class="btn" id="nextBtn">Siguiente →</button>
                </div>
                
                <div class="image-comparison-container" id="comparisonContainer">
                    <!-- Se llenará dinámicamente con JavaScript -->
                </div>
                
                <div class="tools-section">
                    <div class="filters-panel">
                        <h3 class="panel-title">Filtros Preconfigurados</h3>
                        <div class="filter-buttons">
                            <button class="filter-btn" data-filter="original">Original</button>
                            <button class="filter-btn active" data-filter="document">Documento Mejorado</button>
                            <button class="filter-btn" data-filter="aclarar">Aclarar Moderado</button>
                            <button class="filter-btn" data-filter="textoOscuro">Texto Más Oscuro</button>
                            <button class="filter-btn" data-filter="contrast">Alto Contraste</button>
                            <button class="btn btn-success" id="applyToAllBtn">Aplicar a Todos</button>
                        </div>
                        
                        <div class="quality-control">
                            <label>Intensidad del Filtro:</label>
                            <input type="range" min="1" max="10" value="5" class="quality-slider" id="filterIntensity">
                            <span id="intensityValue">5/10</span>
                        </div>
                    </div>
                    
                    <div class="crop-panel">
                        <h3 class="panel-title">Herramientas de Recorte</h3>
                        <div class="crop-instructions">
                            💡 <strong>Instrucciones:</strong> Activa recorte, ajusta el área roja (se mantiene dentro de la imagen) y aplica
                        </div>
                        <div class="crop-controls">
                            <button class="btn" id="cropBtn">Activar Recorte</button>
                            <button class="btn btn-success" id="applyCropBtn">Aplicar Recorte</button>
                            <button class="btn btn-danger" id="cancelCropBtn">Cancelar Recorte</button>
                        </div>
                        <div class="rotation-controls">
                            <button class="btn btn-warning" id="rotateLeftBtn">↺ Girar Izquierda</button>
                            <button class="btn btn-warning" id="rotateRightBtn">↻ Girar Derecha</button>
                        </div>
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn" id="addMoreBtn">Agregar Más Imágenes</button>
                    <button class="btn btn-info" id="takePhotoBtn">Tomar Otra Foto</button>
                    <button class="btn btn-secondary" id="scanMoreBtn">Escanear Más</button>
                    <button class="btn btn-success" id="generateBtn">Generar PDF Mejorado</button>
                    <button class="btn btn-danger" id="clearBtn">Limpiar Todo</button>
                </div>
            </div>
            
            <div class="info-section">
                <h3 class="info-title">Características Mejoradas:</h3>
                <ul class="info-list">
                    <li><strong>Alta Calidad PDF:</strong> Imágenes nítidas sin pérdida de calidad</li>
                    <li><strong>Selección de Impresoras:</strong> Escanea desde impresoras conectadas en red</li>
                    <li><strong>Filtros Optimizados:</strong> Mejor balance entre claridad y naturalidad</li>
                    <li><strong>Múltiples Fuentes:</strong> Archivos, cámara y escáner de impresora</li>
                </ul>
            </div>
        </div>
        
        <footer>
            <p>Mejorador de Documentos Escaneados &copy; 2023</p>
        </footer>
    </div>

    <!-- Modal para la cámara -->
    <div class="camera-modal" id="cameraModal">
        <div class="camera-container">
            <button class="close-camera" id="closeCamera">×</button>
            <video class="camera-preview" id="cameraPreview" autoplay playsinline></video>
            <canvas id="cameraCanvas" style="display: none;"></canvas>
            <div class="camera-flash" id="cameraFlash"></div>
            <div class="camera-controls">
                <button class="btn btn-danger" id="captureBtn">📸 Capturar</button>
                <button class="btn btn-warning" id="switchCameraBtn">🔄 Cambiar Cámara</button>
                <button class="btn" id="flashBtn">⚡ Flash</button>
            </div>
        </div>
    </div>

    <!-- Modal para el escáner -->
    <div class="scanner-modal" id="scannerModal">
        <div class="scanner-container">
            <button class="close-scanner" id="closeScanner">×</button>
            <h3>Escáner de Impresora</h3>
            
            <div class="scanner-instructions">
                <strong>💡 Instrucciones:</strong><br>
                1. Selecciona una impresora de la lista<br>
                2. Configura las opciones de escaneo<br>
                3. Coloca el documento en el escáner<br>
                4. Inicia el escaneo
            </div>

            <div class="scanner-options">
                <div class="scanner-option" id="networkOption">
                    <div class="scanner-option-title">🌐 Impresoras de Red</div>
                    <div class="scanner-option-desc">Escanea desde impresoras conectadas en tu red local</div>
                </div>
                
                <div class="scanner-option" id="localOption">
                    <div class="scanner-option-title">💻 Impresoras Locales</div>
                    <div class="scanner-option-desc">Escáneres conectados directamente a este equipo</div>
                </div>
            </div>

            <div id="printerSelection" style="display: none;">
                <h4>Selecciona una impresora:</h4>
                <div class="printer-list" id="printerList">
                    <!-- Las impresoras se cargarán aquí -->
                </div>
                
                <div class="scanner-settings">
                    <h4>Configuración del Escaneo:</h4>
                    <div style="margin: 10px 0;">
                        <label>Resolución (DPI):</label>
                        <select id="resolutionSelect">
                            <option value="150">150 DPI (Básico)</option>
                            <option value="300" selected>300 DPI (Estándar)</option>
                            <option value="600">600 DPI (Alta Calidad)</option>
                        </select>
                    </div>
                    <div style="margin: 10px 0;">
                        <label>Formato de Color:</label>
                        <select id="colorSelect">
                            <option value="color">Color</option>
                            <option value="grayscale" selected>Escala de Grises</option>
                            <option value="bw">Blanco y Negro</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="scanner-status" id="scannerStatus">
                Selecciona el tipo de impresora para comenzar
            </div>

            <div class="camera-controls">
                <button class="btn btn-success" id="startScanBtn" disabled>Iniciar Escaneo</button>
                <button class="btn btn-secondary" id="scanPreviewBtn" disabled>Vista Previa</button>
                <button class="btn btn-info" id="refreshPrintersBtn">🔄 Actualizar Lista</button>
            </div>
        </div>
    </div>

    <script>
        // Inicializar jsPDF
        const { jsPDF } = window.jspdf;
        
        // Elementos DOM
        const fileInput = document.getElementById('fileInput');
        const selectBtn = document.getElementById('selectBtn');
        const addMoreBtn = document.getElementById('addMoreBtn');
        const takePhotoBtn = document.getElementById('takePhotoBtn');
        const scanMoreBtn = document.getElementById('scanMoreBtn');
        const generateBtn = document.getElementById('generateBtn');
        const clearBtn = document.getElementById('clearBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const applyToAllBtn = document.getElementById('applyToAllBtn');
        const onePerPageBtn = document.getElementById('onePerPage');
        const twoPerPageBtn = document.getElementById('twoPerPage');
        const uploadSection = document.getElementById('uploadSection');
        const previewSection = document.getElementById('previewSection');
        const comparisonContainer = document.getElementById('comparisonContainer');
        const imageCounter = document.getElementById('imageCounter');
        const cropBtn = document.getElementById('cropBtn');
        const applyCropBtn = document.getElementById('applyCropBtn');
        const cancelCropBtn = document.getElementById('cancelCropBtn');
        const rotateLeftBtn = document.getElementById('rotateLeftBtn');
        const rotateRightBtn = document.getElementById('rotateRightBtn');
        const filterIntensity = document.getElementById('filterIntensity');
        const intensityValue = document.getElementById('intensityValue');
        
        // Elementos de cámara
        const fileUploadOption = document.getElementById('fileUploadOption');
        const cameraOption = document.getElementById('cameraOption');
        const scannerOption = document.getElementById('scannerOption');
        const cameraModal = document.getElementById('cameraModal');
        const cameraPreview = document.getElementById('cameraPreview');
        const cameraCanvas = document.getElementById('cameraCanvas');
        const cameraFlash = document.getElementById('cameraFlash');
        const closeCamera = document.getElementById('closeCamera');
        const captureBtn = document.getElementById('captureBtn');
        const switchCameraBtn = document.getElementById('switchCameraBtn');
        const flashBtn = document.getElementById('flashBtn');

        // Elementos de escáner
        const scannerModal = document.getElementById('scannerModal');
        const closeScanner = document.getElementById('closeScanner');
        const networkOption = document.getElementById('networkOption');
        const localOption = document.getElementById('localOption');
        const printerSelection = document.getElementById('printerSelection');
        const printerList = document.getElementById('printerList');
        const resolutionSelect = document.getElementById('resolutionSelect');
        const colorSelect = document.getElementById('colorSelect');
        const scannerStatus = document.getElementById('scannerStatus');
        const startScanBtn = document.getElementById('startScanBtn');
        const scanPreviewBtn = document.getElementById('scanPreviewBtn');
        const refreshPrintersBtn = document.getElementById('refreshPrintersBtn');

        // Elementos de calidad PDF
        const qualityOptions = document.querySelectorAll('.quality-option');

        // Variables globales
        let images = [];
        let currentImageIndex = 0;
        let isCropping = false;
        let currentFilter = 'document';
        let cropArea = null;
        let pdfLayout = 'onePerPage';
        let isDragging = false;
        let dragHandle = null;
        let startX, startY, startWidth, startHeight, startLeft, startTop;
        let pdfQuality = 'high'; // 'high', 'medium', 'low'
        
        // Variables de cámara
        let stream = null;
        let currentFacingMode = 'environment';
        let flashOn = false;

        // Variables de escáner
        let selectedScannerType = null;
        let selectedPrinter = null;

        // Event listeners
        fileUploadOption.addEventListener('click', () => fileInput.click());
        cameraOption.addEventListener('click', openCamera);
        scannerOption.addEventListener('click', openScanner);
        fileInput.addEventListener('change', handleFileSelect);
        generateBtn.addEventListener('click', generatePDF);
        clearBtn.addEventListener('click', clearAll);
        prevBtn.addEventListener('click', showPreviousImage);
        nextBtn.addEventListener('click', showNextImage);
        applyToAllBtn.addEventListener('click', applyCurrentFilterToAll);
        filterIntensity.addEventListener('input', updateIntensityValue);
        filterIntensity.addEventListener('change', () => applyFilter(currentFilter));
        takePhotoBtn.addEventListener('click', openCamera);
        scanMoreBtn.addEventListener('click', openScanner);
        
        // Event listeners de cámara
        closeCamera.addEventListener('click', closeCameraModal);
        captureBtn.addEventListener('click', capturePhoto);
        switchCameraBtn.addEventListener('click', switchCamera);
        flashBtn.addEventListener('click', toggleFlash);

        // Event listeners de escáner
        closeScanner.addEventListener('click', closeScannerModal);
        networkOption.addEventListener('click', () => selectScannerType('network'));
        localOption.addEventListener('click', () => selectScannerType('local'));
        startScanBtn.addEventListener('click', startScanning);
        scanPreviewBtn.addEventListener('click', showScanPreview);
        refreshPrintersBtn.addEventListener('click', loadPrinters);

        // Event listeners de calidad PDF
        qualityOptions.forEach(option => {
            option.addEventListener('click', function() {
                qualityOptions.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                pdfQuality = this.getAttribute('data-quality');
            });
        });

        // Configuración de PDF
        onePerPageBtn.addEventListener('click', () => {
            onePerPageBtn.classList.add('active');
            twoPerPageBtn.classList.remove('active');
            pdfLayout = 'onePerPage';
        });
        
        twoPerPageBtn.addEventListener('click', () => {
            twoPerPageBtn.classList.add('active');
            onePerPageBtn.classList.remove('active');
            pdfLayout = 'twoPerPage';
        });
        
        // Filtros preconfigurados
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.getAttribute('data-filter');
                applyFilter(currentFilter);
            });
        });
        
        // Herramientas de recorte y rotación
        cropBtn.addEventListener('click', activateCrop);
        applyCropBtn.addEventListener('click', applyCrop);
        cancelCropBtn.addEventListener('click', cancelCrop);
        rotateLeftBtn.addEventListener('click', () => rotateImage(-90));
        rotateRightBtn.addEventListener('click', () => rotateImage(90));

        function updateIntensityValue() {
            intensityValue.textContent = `${filterIntensity.value}/10`;
        }

        // Función para abrir la cámara
        async function openCamera() {
            try {
                cameraModal.style.display = 'flex';
                
                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1920 }, // Mayor resolución
                        height: { ideal: 1080 }
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraPreview.srcObject = stream;
                
            } catch (error) {
                console.error('Error al acceder a la cámara:', error);
                alert('No se pudo acceder a la cámara. Asegúrate de permitir el acceso a la cámara.');
                closeCameraModal();
            }
        }

        // Función para cerrar la cámara
        function closeCameraModal() {
            cameraModal.style.display = 'none';
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        // Función para capturar foto (MEJORADA - MAYOR CALIDAD)
        function capturePhoto() {
            if (!stream) return;
            
            cameraFlash.classList.add('flash-active');
            setTimeout(() => {
                cameraFlash.classList.remove('flash-active');
            }, 300);
            
            const context = cameraCanvas.getContext('2d');
            // Usar la resolución nativa de la cámara
            cameraCanvas.width = cameraPreview.videoWidth;
            cameraCanvas.height = cameraPreview.videoHeight;
            context.drawImage(cameraPreview, 0, 0, cameraCanvas.width, cameraCanvas.height);
            
            // Guardar en alta calidad
            const imageData = cameraCanvas.toDataURL('image/jpeg', 0.95);
            addImageFromCamera(imageData);
            
            setTimeout(() => {
                closeCameraModal();
            }, 500);
        }

        // Función para cambiar de cámara
        async function switchCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            await openCamera();
        }

        // Función para toggle flash
        function toggleFlash() {
            flashOn = !flashOn;
            flashBtn.textContent = flashOn ? '⚡ Flash On' : '⚡ Flash';
            flashBtn.style.background = flashOn ? 
                'linear-gradient(to right, #ffd700, #ffed4e)' : 
                'linear-gradient(to right, #1e3c72, #2a5298)';
        }

        // Agregar imagen desde la cámara
        function addImageFromCamera(imageData) {
            const imageDataObj = {
                src: imageData,
                name: `foto_${new Date().getTime()}.jpg`,
                enhancedSrc: imageData,
                filter: 'document',
                rotation: 0,
                crop: null,
                originalData: imageData // Guardar datos originales para PDF de alta calidad
            };
            
            images.push(imageDataObj);
            
            if (images.length === 1) {
                currentImageIndex = 0;
                updateComparisonView();
                applyFilter('document');
            }
            
            updatePreviewSection();
        }

        // Funciones de escáner MEJORADAS
        function openScanner() {
            scannerModal.style.display = 'flex';
            selectedScannerType = null;
            selectedPrinter = null;
            startScanBtn.disabled = true;
            scanPreviewBtn.disabled = true;
            printerSelection.style.display = 'none';
            scannerStatus.innerHTML = 'Selecciona el tipo de impresora para comenzar';
            
            // Cargar impresoras disponibles
            loadPrinters();
        }

        function closeScannerModal() {
            scannerModal.style.display = 'none';
        }

        function selectScannerType(type) {
            selectedScannerType = type;
            
            // Remover selección anterior
            [networkOption, localOption].forEach(opt => {
                opt.style.borderColor = '#e9ecef';
                opt.style.background = 'white';
            });
            
            // Resaltar opción seleccionada
            const selectedOption = document.getElementById(type + 'Option');
            selectedOption.style.borderColor = '#1e3c72';
            selectedOption.style.background = '#f8f9fa';
            
            // Mostrar selección de impresoras
            printerSelection.style.display = 'block';
            scannerStatus.innerHTML = `🌐 <strong>${type === 'network' ? 'Impresoras de Red' : 'Impresoras Locales'}</strong> seleccionadas<br>Selecciona una impresora de la lista`;
        }

        // Cargar lista de impresoras (simulada)
        function loadPrinters() {
            printerList.innerHTML = '';
            scannerStatus.innerHTML = '<div class="loading"></div> Buscando impresoras...';
            
            // Simular búsqueda de impresoras
            setTimeout(() => {
                const printers = [
                    {
                        id: '1',
                        name: 'HP LaserJet Pro MFP M428fdw',
                        type: 'network',
                        status: 'En línea',
                        location: 'Oficina Principal'
                    },
                    {
                        id: '2', 
                        name: 'Canon imageCLASS MF644Cdw',
                        type: 'network',
                        status: 'En línea',
                        location: 'Sala de Reuniones'
                    },
                    {
                        id: '3',
                        name: 'Epson WorkForce WF-2860',
                        type: 'local',
                        status: 'Conectada',
                        location: 'Estación de Trabajo 1'
                    },
                    {
                        id: '4',
                        name: 'Brother MFC-L8900CDW',
                        type: 'network', 
                        status: 'Ocupada',
                        location: 'Departamento Contable'
                    },
                    {
                        id: '5',
                        name: 'Xerox VersaLink C400',
                        type: 'local',
                        status: 'En línea',
                        location: 'Recepción'
                    }
                ];
                
                // Filtrar por tipo seleccionado
                const filteredPrinters = selectedScannerType ? 
                    printers.filter(p => p.type === selectedScannerType) : 
                    printers;
                
                if (filteredPrinters.length === 0) {
                    printerList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No se encontraron impresoras</div>';
                } else {
                    filteredPrinters.forEach(printer => {
                        const printerItem = document.createElement('div');
                        printerItem.className = 'printer-item';
                        printerItem.innerHTML = `
                            <div class="printer-name">${printer.name}</div>
                            <div class="printer-details">
                                ${printer.type === 'network' ? '🌐 Red' : '💻 Local'} | 
                                Estado: ${printer.status} | 
                                Ubicación: ${printer.location}
                            </div>
                        `;
                        
                        printerItem.addEventListener('click', () => {
                            document.querySelectorAll('.printer-item').forEach(item => {
                                item.classList.remove('selected');
                            });
                            printerItem.classList.add('selected');
                            selectedPrinter = printer;
                            startScanBtn.disabled = false;
                            scanPreviewBtn.disabled = false;
                            scannerStatus.innerHTML = `✅ <strong>${printer.name}</strong> seleccionada<br>Configura las opciones y inicia el escaneo`;
                        });
                        
                        printerList.appendChild(printerItem);
                    });
                }
                
                scannerStatus.innerHTML = `🔍 Se encontraron ${filteredPrinters.length} impresoras<br>Selecciona una para continuar`;
            }, 1500);
        }

        function startScanning() {
            if (!selectedScannerType || !selectedPrinter) {
                alert('Por favor, selecciona una impresora primero.');
                return;
            }

            const resolution = resolutionSelect.value;
            const colorMode = colorSelect.value;
            
            scannerStatus.innerHTML = `<div class="loading"></div> Escaneando desde ${selectedPrinter.name}... (${resolution} DPI, ${colorMode})`;

            // Simular proceso de escaneo real
            setTimeout(() => {
                simulateScannerResult(resolution, colorMode);
            }, 3000);
        }

        function showScanPreview() {
            if (!selectedScannerType || !selectedPrinter) {
                alert('Por favor, selecciona una impresora primero.');
                return;
            }
            
            const resolution = resolutionSelect.value;
            const colorMode = colorSelect.value;
            
            scannerStatus.innerHTML = `📋 <strong>Vista previa del escaneo</strong><br>Impresora: ${selectedPrinter.name}<br>Resolución: ${resolution} DPI | Color: ${colorMode}`;
            
            // En una implementación real, aquí se integraría con las APIs del escáner
            alert(`Vista previa del escaneo:\n- Impresora: ${selectedPrinter.name}\n- Resolución: ${resolution} DPI\n- Color: ${colorMode}\n\nEn una implementación completa, se mostraría la vista previa real del documento.`);
        }

        function simulateScannerResult(resolution, colorMode) {
            // Crear una imagen de alta calidad simulando un escaneo real
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Ajustar tamaño según resolución
            const baseSize = 800;
            const scale = parseInt(resolution) / 150;
            canvas.width = baseSize * scale;
            canvas.height = (baseSize * 0.75) * scale;
            
            // Fondo de alta calidad
            ctx.fillStyle = '#f8f8f8';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Simular texto escaneado en alta resolución
            ctx.fillStyle = colorMode === 'color' ? '#2c3e50' : 
                           colorMode === 'grayscale' ? '#4a4a4a' : '#000000';
            
            const fontSize = 24 * scale;
            ctx.font = `bold ${fontSize}px Arial`;
            ctx.fillText('DOCUMENTO ESCANEADO - ALTA CALIDAD', 50 * scale, 100 * scale);
            
            ctx.font = `${16 * scale}px Arial`;
            ctx.fillText(`Impresora: ${selectedPrinter.name}`, 50 * scale, 150 * scale);
            ctx.fillText(`Resolución: ${resolution} DPI`, 50 * scale, 180 * scale);
            ctx.fillText(`Color: ${colorMode}`, 50 * scale, 210 * scale);
            ctx.fillText(`Fecha: ${new Date().toLocaleString()}`, 50 * scale, 240 * scale);
            
            // Agregar contenido de documento simulado
            ctx.fillText('Este es un documento escaneado de ejemplo con alta calidad.', 50 * scale, 300 * scale);
            ctx.fillText('El texto se ve nítido y claro gracias a la alta resolución.', 50 * scale, 330 * scale);
            
            // Agregar algunas líneas para simular un documento
            ctx.strokeStyle = colorMode === 'color' ? '#3498db' : 
                             colorMode === 'grayscale' ? '#888888' : '#cccccc';
            ctx.lineWidth = 1 * scale;
            for (let i = 400 * scale; i < 500 * scale; i += 20 * scale) {
                ctx.beginPath();
                ctx.moveTo(50 * scale, i);
                ctx.lineTo(canvas.width - 50 * scale, i);
                ctx.stroke();
            }
            
            // Guardar en alta calidad
            const quality = pdfQuality === 'high' ? 1.0 : pdfQuality === 'medium' ? 0.8 : 0.6;
            const imageData = canvas.toDataURL('image/jpeg', quality);
            addImageFromScanner(imageData, selectedPrinter.name);
            
            scannerStatus.innerHTML = `✅ <strong>Escaneo completado con éxito</strong><br>Documento agregado desde ${selectedPrinter.name}<br>Calidad: ${resolution} DPI | ${colorMode}`;
        }

        function addImageFromScanner(imageData, printerName) {
            const imageDataObj = {
                src: imageData,
                name: `escaneo_${printerName.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().getTime()}.jpg`,
                enhancedSrc: imageData,
                filter: 'document',
                rotation: 0,
                crop: null,
                source: 'scanner',
                originalData: imageData // Guardar datos originales para PDF de alta calidad
            };
            
            images.push(imageDataObj);
            
            if (images.length === 1) {
                currentImageIndex = 0;
                updateComparisonView();
                applyFilter('document');
            }
            
            updatePreviewSection();
            closeScannerModal();
        }

        // Manejar la selección de archivos
        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            const filesToProcess = Math.min(files.length, 10);
            let loadedCount = 0;
            
            for (let i = 0; i < filesToProcess; i++) {
                const file = files[i];
                if (!file.type.match('image.*')) continue;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = {
                        src: e.target.result,
                        name: file.name,
                        enhancedSrc: e.target.result,
                        filter: 'document',
                        rotation: 0,
                        crop: null,
                        originalData: e.target.result // Guardar datos originales
                    };
                    
                    images.push(imageData);
                    loadedCount++;
                    
                    if (loadedCount === filesToProcess) {
                        currentImageIndex = 0;
                        updateComparisonView();
                        applyFilter('document');
                        updatePreviewSection();
                    }
                };
                reader.readAsDataURL(file);
            }
            fileInput.value = '';
        }

        // Actualizar la vista de comparación
        function updateComparisonView() {
            if (images.length === 0) return;
            
            const currentImage = images[currentImageIndex];
            comparisonContainer.innerHTML = `
                <div class="comparison-box">
                    <div class="comparison-header">Imagen Original</div>
                    <div class="comparison-image-container">
                        <span class="image-counter">${currentImageIndex + 1} / ${images.length}</span>
                        <img src="${currentImage.src}" alt="Original" class="comparison-image" id="originalImage">
                    </div>
                </div>
                <div class="comparison-box">
                    <div class="comparison-header">Imagen Mejorada</div>
                    <div class="comparison-image-container" id="enhancedContainer">
                        <img src="${currentImage.enhancedSrc}" alt="Mejorada" class="comparison-image" id="enhancedImage">
                        <div class="crop-overlay" id="cropOverlay"></div>
                    </div>
                </div>
            `;
            
            imageCounter.textContent = `Imagen ${currentImageIndex + 1} de ${images.length}`;
            prevBtn.disabled = currentImageIndex === 0;
            nextBtn.disabled = currentImageIndex === images.length - 1;
        }

        // Navegación
        function showPreviousImage() {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                updateComparisonView();
                applyFilter(currentFilter);
            }
        }
        
        function showNextImage() {
            if (currentImageIndex < images.length - 1) {
                currentImageIndex++;
                updateComparisonView();
                applyFilter(currentFilter);
            }
        }

        // Actualizar la sección de vista previa
        function updatePreviewSection() {
            if (images.length === 0) {
                previewSection.style.display = 'none';
                uploadSection.style.display = 'block';
                takePhotoBtn.style.display = 'none';
                scanMoreBtn.style.display = 'none';
                return;
            }
            previewSection.style.display = 'block';
            uploadSection.style.display = 'none';
            takePhotoBtn.style.display = 'inline-block';
            scanMoreBtn.style.display = 'inline-block';
        }

        // Aplicar filtro (sin cambios en esta parte)
        function applyFilter(filterName) {
            if (images.length === 0) return;
            
            const currentImage = images[currentImageIndex];
            const img = new Image();
            img.src = currentImage.src;
            
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                if (currentImage.rotation !== 0) {
                    if (currentImage.rotation % 180 === 0) {
                        canvas.width = img.width;
                        canvas.height = img.height;
                    } else {
                        canvas.width = img.height;
                        canvas.height = img.width;
                    }
                    
                    ctx.save();
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate(currentImage.rotation * Math.PI / 180);
                    ctx.drawImage(img, -img.width / 2, -img.height / 2, img.width, img.height);
                    ctx.restore();
                } else {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                }
                
                let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                let data = imageData.data;
                
                const intensity = parseInt(filterIntensity.value) / 10;
                
                switch(filterName) {
                    case 'document':
                        applyEnhancedDocumentFilter(data, intensity);
                        break;
                    case 'aclarar':
                        applyModerateBrightnessFilter(data, intensity);
                        break;
                    case 'textoOscuro':
                        applyDarkerTextFilter(data, intensity);
                        break;
                    case 'contrast':
                        applyHighContrastFilter(data, intensity);
                        break;
                    default:
                        break;
                }
                
                if (filterName !== 'original') {
                    ctx.putImageData(imageData, 0, 0);
                }
                
                if (currentImage.crop) {
                    const cropCanvas = document.createElement('canvas');
                    const cropCtx = cropCanvas.getContext('2d');
                    cropCanvas.width = currentImage.crop.width;
                    cropCanvas.height = currentImage.crop.height;
                    
                    cropCtx.drawImage(
                        canvas, 
                        currentImage.crop.x, 
                        currentImage.crop.y, 
                        currentImage.crop.width, 
                        currentImage.crop.height,
                        0, 0, 
                        currentImage.crop.width, 
                        currentImage.crop.height
                    );
                    
                    currentImage.enhancedSrc = cropCanvas.toDataURL('image/jpeg', 0.9);
                } else {
                    currentImage.enhancedSrc = canvas.toDataURL('image/jpeg', 0.9);
                }
                
                currentImage.filter = filterName;
                updateComparisonView();
            };
        }

        // FILTROS (sin cambios)
        function applyEnhancedDocumentFilter(data, intensity) {
            let grayscale = [];
            for (let i = 0; i < data.length; i += 4) {
                const gray = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                grayscale.push(gray);
            }
            
            let threshold = 128;
            if (intensity > 0.5) {
                threshold = 128 - (intensity - 0.5) * 50;
            } else {
                threshold = 128 + (0.5 - intensity) * 50;
            }
            
            let grayIndex = 0;
            for (let i = 0; i < data.length; i += 4) {
                const gray = grayscale[grayIndex++];
                const adjustedThreshold = Math.max(50, Math.min(200, threshold));
                
                if (gray > adjustedThreshold) {
                    data[i] = data[i+1] = data[i+2] = 255;
                } else {
                    data[i] = data[i+1] = data[i+2] = 0;
                }
            }
        }
        
        function applyModerateBrightnessFilter(data, intensity) {
            const brightness = 1.0 + (intensity * 0.4);
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, data[i] * brightness);
                data[i+1] = Math.min(255, data[i+1] * brightness);
                data[i+2] = Math.min(255, data[i+2] * brightness);
            }
        }
        
        function applyDarkerTextFilter(data, intensity) {
            for (let i = 0; i < data.length; i += 4) {
                const gray = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                const threshold = 180 - (intensity * 40);
                if (gray > threshold) {
                    data[i] = data[i+1] = data[i+2] = 255;
                } else {
                    data[i] = data[i+1] = data[i+2] = 0;
                }
            }
        }
        
        function applyHighContrastFilter(data, intensity) {
            const contrast = 1.0 + (intency * 2.0);
            const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.max(0, Math.min(255, factor * (data[i] - 128) + 128));
                data[i+1] = Math.max(0, Math.min(255, factor * (data[i+1] - 128) + 128));
                data[i+2] = Math.max(0, Math.min(255, factor * (data[i+2] - 128) + 128));
            }
        }

        // Aplicar filtro actual a todas las imágenes
        function applyCurrentFilterToAll() {
            if (images.length === 0) return;
            
            images.forEach((image, index) => {
                if (index !== currentImageIndex) {
                    const tempImg = new Image();
                    tempImg.src = image.src;
                    
                    tempImg.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = tempImg.width;
                        canvas.height = tempImg.height;
                        ctx.drawImage(tempImg, 0, 0);
                        
                        let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        let data = imageData.data;
                        const intensity = parseInt(filterIntensity.value) / 10;
                        
                        switch(currentFilter) {
                            case 'document': applyEnhancedDocumentFilter(data, intensity); break;
                            case 'aclarar': applyModerateBrightnessFilter(data, intensity); break;
                            case 'textoOscuro': applyDarkerTextFilter(data, intensity); break;
                            case 'contrast': applyHighContrastFilter(data, intensity); break;
                        }
                        
                        ctx.putImageData(imageData, 0, 0);
                        image.enhancedSrc = canvas.toDataURL('image/jpeg', 0.9);
                        image.filter = currentFilter;
                    };
                }
            });
            
            alert(`Filtro aplicado a todas las ${images.length} imágenes`);
        }

        // GENERAR PDF MEJORADO - ALTA CALIDAD
        function generatePDF() {
            if (images.length === 0) {
                alert('Por favor, selecciona al menos una imagen.');
                return;
            }
            
            try {
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    compress: pdfQuality !== 'high' // Comprimir solo en calidades menores
                });
                
                const pageWidth = 210;
                const pageHeight = 297;
                
                // Configurar calidad según selección
                let jpegQuality;
                switch(pdfQuality) {
                    case 'high':
                        jpegQuality = 1.0;
                        break;
                    case 'medium':
                        jpegQuality = 0.8;
                        break;
                    case 'low':
                        jpegQuality = 0.6;
                        break;
                }
                
                if (pdfLayout === 'onePerPage') {
                    images.forEach((image, index) => {
                        if (index > 0) pdf.addPage();
                        // Usar datos originales para máxima calidad
                        const imgSrc = image.originalData || image.enhancedSrc || image.src;
                        pdf.addImage(imgSrc, 'JPEG', 0, 0, pageWidth, pageHeight, undefined, 'FAST', 0, jpegQuality);
                    });
                } else {
                    for (let i = 0; i < images.length; i += 2) {
                        if (i > 0) pdf.addPage();
                        
                        const img1Src = images[i].originalData || images[i].enhancedSrc || images[i].src;
                        pdf.addImage(img1Src, 'JPEG', 0, 0, pageWidth, pageHeight / 2, undefined, 'FAST', 0, jpegQuality);
                        
                        if (i + 1 < images.length) {
                            const img2Src = images[i + 1].originalData || images[i + 1].enhancedSrc || images[i + 1].src;
                            pdf.addImage(img2Src, 'JPEG', 0, pageHeight / 2, pageWidth, pageHeight / 2, undefined, 'FAST', 0, jpegQuality);
                        }
                    }
                }
                
                pdf.save('documentos_alta_calidad.pdf');
                alert(`✅ PDF generado correctamente con ${images.length} imágenes\nCalidad: ${pdfQuality === 'high' ? 'Alta' : pdfQuality === 'medium' ? 'Media' : 'Básica'}\nFormato: ${pdfLayout === 'onePerPage' ? '1 por página' : '2 por página'}`);
            } catch (error) {
                console.error('Error:', error);
                alert('Error al generar PDF. Verifica que las imágenes sean válidas.');
            }
        }

        // Resto de funciones (recorte, rotación, etc.) se mantienen igual
        function activateCrop() {
            if (images.length === 0) return;
            isCropping = true;
            const overlay = document.getElementById('cropOverlay');
            const enhancedImg = document.getElementById('enhancedImage');
            if (!overlay || !enhancedImg) return;
            overlay.style.display = 'block';
            const containerRect = overlay.getBoundingClientRect();
            const cropWidth = containerRect.width * 0.8;
            const cropHeight = containerRect.height * 0.8;
            const cropX = (containerRect.width - cropWidth) / 2;
            const cropY = (containerRect.height - cropHeight) / 2;
            createCropArea(cropX, cropY, cropWidth, cropHeight);
            setupCropEvents();
        }
        
        function createCropArea(x, y, width, height) {
            const overlay = document.getElementById('cropOverlay');
            if (!overlay) return;
            overlay.innerHTML = '';
            cropArea = document.createElement('div');
            cropArea.className = 'crop-area';
            cropArea.style.left = x + 'px';
            cropArea.style.top = y + 'px';
            cropArea.style.width = width + 'px';
            cropArea.style.height = height + 'px';
            const handles = ['tl', 'tr', 'bl', 'br'];
            handles.forEach(handle => {
                const handleEl = document.createElement('div');
                handleEl.className = `crop-handle handle-${handle}`;
                handleEl.dataset.handle = handle;
                cropArea.appendChild(handleEl);
            });
            overlay.appendChild(cropArea);
        }
        
        function setupCropEvents() {
            if (!cropArea) return;
            const handles = cropArea.querySelectorAll('.crop-handle');
            handles.forEach(handle => {
                handle.addEventListener('mousedown', startResize);
            });
            cropArea.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', doDragResize);
            document.addEventListener('mouseup', stopDragResize);
        }
        
        function startResize(e) {
            e.stopPropagation();
            e.preventDefault();
            isDragging = true;
            dragHandle = e.target.dataset.handle;
            const rect = cropArea.getBoundingClientRect();
            startX = e.clientX;
            startY = e.clientY;
            startWidth = rect.width;
            startHeight = rect.height;
            startLeft = rect.left;
            startTop = rect.top;
        }
        
        function startDrag(e) {
            if (e.target.classList.contains('crop-handle')) return;
            e.preventDefault();
            isDragging = true;
            dragHandle = 'move';
            const rect = cropArea.getBoundingClientRect();
            startX = e.clientX;
            startY = e.clientY;
            startLeft = rect.left;
            startTop = rect.top;
        }
        
        function doDragResize(e) {
            if (!isDragging || !cropArea) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            const overlay = document.getElementById('cropOverlay');
            const overlayRect = overlay.getBoundingClientRect();
            const minX = overlayRect.left;
            const minY = overlayRect.top;
            const maxX = overlayRect.right;
            const maxY = overlayRect.bottom;
            if (dragHandle === 'move') {
                let newLeft = startLeft + dx;
                let newTop = startTop + dy;
                newLeft = Math.max(minX, Math.min(newLeft, maxX - cropArea.offsetWidth));
                newTop = Math.max(minY, Math.min(newTop, maxY - cropArea.offsetHeight));
                cropArea.style.left = (newLeft - minX) + 'px';
                cropArea.style.top = (newTop - minY) + 'px';
            } else {
                let newWidth = startWidth;
                let newHeight = startHeight;
                let newLeft = startLeft;
                let newTop = startTop;
                switch(dragHandle) {
                    case 'tr':
                        newWidth = Math.max(50, startWidth + dx);
                        newHeight = Math.max(50, startHeight - dy);
                        newTop = Math.max(minY, startTop + dy);
                        break;
                    case 'tl':
                        newWidth = Math.max(50, startWidth - dx);
                        newHeight = Math.max(50, startHeight - dy);
                        newLeft = Math.max(minX, startLeft + dx);
                        newTop = Math.max(minY, startTop + dy);
                        break;
                    case 'br':
                        newWidth = Math.max(50, startWidth + dx);
                        newHeight = Math.max(50, startHeight + dy);
                        break;
                    case 'bl':
                        newWidth = Math.max(50, startWidth - dx);
                        newHeight = Math.max(50, startHeight + dy);
                        newLeft = Math.max(minX, startLeft + dx);
                        break;
                }
                newLeft = Math.max(minX, newLeft);
                newTop = Math.max(minY, newTop);
                newWidth = Math.min(newWidth, maxX - newLeft);
                newHeight = Math.min(newHeight, maxY - newTop);
                cropArea.style.left = (newLeft - minX) + 'px';
                cropArea.style.top = (newTop - minY) + 'px';
                cropArea.style.width = newWidth + 'px';
                cropArea.style.height = newHeight + 'px';
            }
        }
        
        function stopDragResize() {
            isDragging = false;
            dragHandle = null;
        }
        
        function applyCrop() {
            if (!isCropping || !cropArea) return;
            const currentImage = images[currentImageIndex];
            const enhancedImg = document.getElementById('enhancedImage');
            if (!enhancedImg) return;
            const imgRect = enhancedImg.getBoundingClientRect();
            const cropRect = cropArea.getBoundingClientRect();
            const scaleX = enhancedImg.naturalWidth / imgRect.width;
            const scaleY = enhancedImg.naturalHeight / imgRect.height;
            currentImage.crop = {
                x: (cropRect.left - imgRect.left) * scaleX,
                y: (cropRect.top - imgRect.top) * scaleY,
                width: cropRect.width * scaleX,
                height: cropRect.height * scaleY
            };
            applyFilter(currentFilter);
            isCropping = false;
            document.getElementById('cropOverlay').style.display = 'none';
            alert('Recorte aplicado correctamente');
        }
        
        function cancelCrop() {
            isCropping = false;
            const overlay = document.getElementById('cropOverlay');
            if (overlay) {
                overlay.style.display = 'none';
                overlay.innerHTML = '';
            }
            cropArea = null;
            isDragging = false;
            dragHandle = null;
        }
        
        function rotateImage(degrees) {
            if (images.length === 0) return;
            const currentImage = images[currentImageIndex];
            currentImage.rotation = (currentImage.rotation + degrees) % 360;
            applyFilter(currentFilter);
        }
        
        function clearAll() {
            images = [];
            currentImageIndex = 0;
            isCropping = false;
            currentFilter = 'document';
            cropArea = null;
            filterIntensity.value = 5;
            intensityValue.textContent = '5/10';
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-filter="document"]').classList.add('active');
            updatePreviewSection();
        }

        // Inicializar valor de intensidad
        updateIntensityValue();
    </script>
</body>
</html>