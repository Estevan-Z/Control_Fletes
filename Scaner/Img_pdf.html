<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mejorador de Documentos Escaneados</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(to right, #1e3c72, #2a5298);
            color: white;
            padding: 25px;
            text-align: center;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .config-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .config-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .config-btn {
            background: white;
            border: 2px solid #1e3c72;
            color: #1e3c72;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .config-btn.active {
            background: #1e3c72;
            color: white;
        }

        .upload-section {
            background-color: #f8f9fa;
            border: 2px dashed #1e3c72;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            background-color: #eef2ff;
            border-color: #2a5298;
        }

        .upload-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .upload-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .upload-option:hover {
            border-color: #1e3c72;
            background: #f8f9fa;
        }

        .upload-option-icon {
            font-size: 40px;
            color: #1e3c72;
        }

        .upload-option-text {
            font-weight: 600;
            color: #1e3c72;
            text-align: center;
        }

        .upload-icon {
            font-size: 50px;
            color: #1e3c72;
            margin-bottom: 15px;
        }

        .upload-text {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(to right, #1e3c72, #2a5298);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 0.95rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(30, 60, 114, 0.3);
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 60, 114, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-success {
            background: linear-gradient(to right, #11998e, #38ef7d);
        }

        .btn-warning {
            background: linear-gradient(to right, #f46b45, #eea849);
        }

        .btn-danger {
            background: linear-gradient(to right, #ff416c, #ff4b2b);
        }

        .btn-info {
            background: linear-gradient(to right, #007bff, #0056b3);
        }

        .btn-secondary {
            background: linear-gradient(to right, #6c757d, #495057);
        }

        .preview-section {
            display: none;
        }

        .preview-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #1e3c72;
            text-align: center;
        }

        .image-comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .comparison-box {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            background: white;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .comparison-header {
            background: #f8f9fa;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            border-bottom: 1px solid #eee;
            font-size: 1rem;
        }

        .comparison-image-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            min-height: 400px;
        }

        .comparison-image {
            width: 100%;
            height: 100%;
            max-height: 500px;
            object-fit: contain;
            display: block;
            padding: 10px;
        }

        .tools-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .filters-panel, .crop-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .panel-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #1e3c72;
            text-align: center;
        }

        .filter-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .filter-btn {
            background: white;
            border: 2px solid #1e3c72;
            color: #1e3c72;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-align: center;
        }

        .filter-btn:hover {
            background: #1e3c72;
            color: white;
        }

        .filter-btn.active {
            background: #1e3c72;
            color: white;
        }

        .crop-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .rotation-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .info-section {
            background-color: #eef2ff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .info-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #1e3c72;
        }

        .info-list {
            padding-left: 20px;
        }

        .info-list li {
            margin-bottom: 8px;
        }

        footer {
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
        }

        @media (max-width: 768px) {
            .image-comparison-container, .tools-section {
                grid-template-columns: 1fr;
            }
            
            .filter-buttons {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }

            .upload-options {
                flex-direction: column;
                align-items: center;
            }
        }

        /* Estilos para el recorte */
        .crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            cursor: crosshair;
            display: none;
            background: rgba(0,0,0,0.3);
        }

        .crop-area {
            position: absolute;
            border: 2px solid #ff0000;
            background: rgba(255, 0, 0, 0.1);
            cursor: move;
            box-sizing: border-box;
        }

        .crop-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ff0000;
            border: 2px solid white;
            border-radius: 50%;
        }

        .handle-tl { top: -6px; left: -6px; cursor: nw-resize; }
        .handle-tr { top: -6px; right: -6px; cursor: ne-resize; }
        .handle-bl { bottom: -6px; left: -6px; cursor: sw-resize; }
        .handle-br { bottom: -6px; right: -6px; cursor: se-resize; }

        .image-counter {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        .navigation-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        .crop-instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9rem;
            color: #856404;
        }

        .quality-control {
            margin-top: 15px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
        }

        .quality-slider {
            width: 100%;
            margin: 10px 0;
        }

        /* Estilos para modales */
        .scanner-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .scanner-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            position: relative;
            width: 500px;
        }

        .close-scanner {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .scanner-steps {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .scanner-step {
            flex: 1;
            text-align: center;
            padding: 10px;
            font-weight: 600;
            color: #6c757d;
            border-bottom: 3px solid transparent;
        }

        .scanner-step.active {
            color: #1e3c72;
            border-bottom-color: #1e3c72;
        }

        .scanner-step.completed {
            color: #28a745;
            border-bottom-color: #28a745;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .printer-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 15px 0;
        }

        .printer-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .printer-item:hover {
            background: #f8f9fa;
        }

        .printer-item.selected {
            background: #1e3c72;
            color: white;
        }

        .printer-name {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .printer-details {
            font-size: 0.9rem;
            margin-top: 5px;
            opacity: 0.8;
        }

        .printer-item.selected .printer-details {
            opacity: 0.9;
        }

        .scanner-settings {
            margin: 20px 0;
        }

        .setting-group {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .setting-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1e3c72;
        }

        .setting-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            background: white;
        }

        .scanner-status {
            text-align: center;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            background: #e2e3e5;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1e3c72;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pdf-quality {
            margin-top: 10px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
        }

        .quality-options {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .quality-option {
            flex: 1;
            padding: 8px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
        }

        .quality-option.selected {
            border-color: #1e3c72;
            background: #1e3c72;
            color: white;
        }

        .step-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Mejorador de Documentos Escaneados</h1>
            <p class="subtitle">C√°mara nativa, esc√°ner con impresoras de red y PDF de alta calidad</p>
        </header>
        
        <div class="main-content">
            <!-- Secci√≥n de configuraci√≥n -->
            <div class="config-section" id="configSection">
                <h3>Configuraci√≥n del PDF</h3>
                <p>Selecciona c√≥mo quieres organizar las im√°genes en el PDF:</p>
                <div class="config-options">
                    <button class="config-btn active" id="onePerPage">1 Imagen por P√°gina</button>
                    <button class="config-btn" id="twoPerPage">2 Im√°genes por P√°gina</button>
                </div>

                <div class="pdf-quality">
                    <label>Calidad del PDF:</label>
                    <div class="quality-options">
                        <div class="quality-option selected" data-quality="high">Alta Calidad</div>
                        <div class="quality-option" data-quality="medium">Calidad Media</div>
                        <div class="quality-option" data-quality="low">Tama√±o Peque√±o</div>
                    </div>
                </div>
            </div>

            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">üìÑ</div>
                <h2 class="upload-text">Sube o captura tus documentos</h2>
                <p>M√∫ltiples formas de obtener tus im√°genes - M√°ximo 10 im√°genes</p>
                
                <div class="upload-options">
                    <div class="upload-option" id="fileUploadOption">
                        <div class="upload-option-icon">üìÅ</div>
                        <div class="upload-option-text">Subir Archivos</div>
                    </div>
                    <div class="upload-option" id="cameraOption">
                        <div class="upload-option-icon">üì∑</div>
                        <div class="upload-option-text">C√°mara Nativa</div>
                    </div>
                    <div class="upload-option" id="scannerOption">
                        <div class="upload-option-icon">üñ®Ô∏è</div>
                        <div class="upload-option-text">Esc√°ner con Impresora</div>
                    </div>
                </div>
                
                <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>
                <input type="file" id="cameraInput" class="file-input" accept="image/*" capture="environment">
                <button class="btn" id="selectBtn" style="display: none;">Seleccionar Im√°genes</button>
            </div>
            
            <div class="preview-section" id="previewSection">
                <h2 class="preview-title">Mejora tus Documentos</h2>
                
                <div class="navigation-buttons">
                    <button class="btn" id="prevBtn">‚Üê Anterior</button>
                    <span id="imageCounter">Imagen 1 de 1</span>
                    <button class="btn" id="nextBtn">Siguiente ‚Üí</button>
                </div>
                
                <div class="image-comparison-container" id="comparisonContainer">
                    <!-- Se llenar√° din√°micamente con JavaScript -->
                </div>
                
                <div class="tools-section">
                    <div class="filters-panel">
                        <h3 class="panel-title">Filtros Preconfigurados</h3>
                        <div class="filter-buttons">
                            <button class="filter-btn" data-filter="original">Original</button>
                            <button class="filter-btn active" data-filter="document">Documento Mejorado</button>
                            <button class="filter-btn" data-filter="aclarar">Aclarar Moderado</button>
                            <button class="filter-btn" data-filter="textoOscuro">Texto M√°s Oscuro</button>
                            <button class="filter-btn" data-filter="contrast">Alto Contraste</button>
                            <button class="btn btn-success" id="applyToAllBtn">Aplicar a Todos</button>
                        </div>
                        
                        <div class="quality-control">
                            <label>Intensidad del Filtro:</label>
                            <input type="range" min="1" max="10" value="5" class="quality-slider" id="filterIntensity">
                            <span id="intensityValue">5/10</span>
                        </div>
                    </div>
                    
                    <div class="crop-panel">
                        <h3 class="panel-title">Herramientas de Recorte</h3>
                        <div class="crop-instructions">
                            üí° <strong>Instrucciones:</strong> Activa recorte, ajusta el √°rea roja (se mantiene dentro de la imagen) y aplica
                        </div>
                        <div class="crop-controls">
                            <button class="btn" id="cropBtn">Activar Recorte</button>
                            <button class="btn btn-success" id="applyCropBtn">Aplicar Recorte</button>
                            <button class="btn btn-danger" id="cancelCropBtn">Cancelar Recorte</button>
                        </div>
                        <div class="rotation-controls">
                            <button class="btn btn-warning" id="rotateLeftBtn">‚Ü∫ Girar Izquierda</button>
                            <button class="btn btn-warning" id="rotateRightBtn">‚Üª Girar Derecha</button>
                        </div>
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn" id="addMoreBtn">Agregar M√°s Im√°genes</button>
                    <button class="btn btn-info" id="takePhotoBtn">Usar C√°mara</button>
                    <button class="btn btn-secondary" id="scanMoreBtn">Escanear M√°s</button>
                    <button class="btn btn-success" id="generateBtn">Generar PDF Mejorado</button>
                    <button class="btn btn-danger" id="clearBtn">Limpiar Todo</button>
                </div>
            </div>
            
            <div class="info-section">
                <h3 class="info-title">Caracter√≠sticas Mejoradas:</h3>
                <ul class="info-list">
                    <li><strong>C√°mara Nativa:</strong> Usa la aplicaci√≥n de c√°mara de tu tel√©fono</li>
                    <li><strong>Selecci√≥n de Impresoras:</strong> Escanea desde impresoras de red disponibles</li>
                    <li><strong>Configuraci√≥n Flexible:</strong> Elige platina, calidad, color y tama√±o</li>
                    <li><strong>Alta Calidad PDF:</strong> Im√°genes n√≠tidas sin p√©rdida de calidad</li>
                </ul>
            </div>
        </div>
        
        <footer>
            <p>Mejorador de Documentos Escaneados &copy; 2023</p>
        </footer>
    </div>

    <!-- Modal para el esc√°ner -->
    <div class="scanner-modal" id="scannerModal">
        <div class="scanner-container">
            <button class="close-scanner" id="closeScanner">√ó</button>
            <h3>Esc√°ner con Impresora</h3>
            
            <div class="scanner-steps">
                <div class="scanner-step active" id="step1">1. Seleccionar Impresora</div>
                <div class="scanner-step" id="step2">2. Configurar Escaneo</div>
                <div class="scanner-step" id="step3">3. Escanear</div>
            </div>

            <!-- Paso 1: Selecci√≥n de Impresora -->
            <div class="step-content active" id="step1Content">
                <div class="scanner-instructions">
                    <strong>üí° Paso 1:</strong> Selecciona una impresora de red para escanear
                </div>

                <div class="printer-list" id="printerList">
                    <!-- Las impresoras se cargar√°n aqu√≠ -->
                </div>

                <div class="scanner-status" id="scannerStatus">
                    üîç Buscando impresoras en la red...
                </div>

                <div class="step-actions">
                    <button class="btn btn-secondary" id="refreshPrintersBtn">üîÑ Actualizar Lista</button>
                    <button class="btn btn-success" id="nextStep1Btn" disabled>Siguiente ‚Üí</button>
                </div>
            </div>

            <!-- Paso 2: Configuraci√≥n del Escaneo -->
            <div class="step-content" id="step2Content">
                <div class="scanner-instructions">
                    <strong>üí° Paso 2:</strong> Configura los par√°metros del escaneo
                </div>

                <div class="scanner-settings">
                    <div class="setting-group">
                        <label>üìÑ Fuente del Documento:</label>
                        <select id="documentSource">
                            <option value="flatbed">Platina de vidrio</option>
                            <option value="adf">Alimentador autom√°tico (ADF)</option>
                        </select>
                    </div>
                    
                    <div class="setting-group">
                        <label>üéØ Calidad de Escaneo:</label>
                        <select id="scanQuality">
                            <option value="150">Borrador (150 DPI)</option>
                            <option value="300" selected>Est√°ndar (300 DPI)</option>
                            <option value="600">Alta calidad (600 DPI)</option>
                        </select>
                    </div>
                    
                    <div class="setting-group">
                        <label>üé® Formato de Color:</label>
                        <select id="colorFormat">
                            <option value="color">Color</option>
                            <option value="grayscale" selected>Escala de grises</option>
                            <option value="bw">Blanco y negro</option>
                        </select>
                    </div>
                    
                    <div class="setting-group">
                        <label>üìè Tama√±o del Documento:</label>
                        <select id="documentSize">
                            <option value="letter" selected>Carta (8.5" x 11")</option>
                            <option value="legal">Legal (8.5" x 14")</option>
                            <option value="a4">A4 (210mm x 297mm)</option>
                        </select>
                    </div>
                </div>

                <div class="scanner-status" id="step2Status">
                    Impresora seleccionada: <span id="selectedPrinterName">-</span>
                </div>

                <div class="step-actions">
                    <button class="btn btn-secondary" id="backStep2Btn">‚Üê Anterior</button>
                    <button class="btn btn-success" id="nextStep2Btn">Siguiente ‚Üí</button>
                </div>
            </div>

            <!-- Paso 3: Escanear -->
            <div class="step-content" id="step3Content">
                <div class="scanner-instructions">
                    <strong>üí° Paso 3:</strong> Inicia el proceso de escaneo
                </div>

                <div class="scanner-status" id="step3Status">
                    <div id="scanConfigSummary">
                        <!-- Resumen de configuraci√≥n -->
                    </div>
                </div>

                <div class="step-actions">
                    <button class="btn btn-secondary" id="backStep3Btn">‚Üê Anterior</button>
                    <button class="btn btn-success" id="startScanBtn">üöÄ Iniciar Escaneo</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inicializar jsPDF
        const { jsPDF } = window.jspdf;
        
        // Elementos DOM
        const fileInput = document.getElementById('fileInput');
        const cameraInput = document.getElementById('cameraInput');
        const selectBtn = document.getElementById('selectBtn');
        const addMoreBtn = document.getElementById('addMoreBtn');
        const takePhotoBtn = document.getElementById('takePhotoBtn');
        const scanMoreBtn = document.getElementById('scanMoreBtn');
        const generateBtn = document.getElementById('generateBtn');
        const clearBtn = document.getElementById('clearBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const applyToAllBtn = document.getElementById('applyToAllBtn');
        const onePerPageBtn = document.getElementById('onePerPage');
        const twoPerPageBtn = document.getElementById('twoPerPage');
        const uploadSection = document.getElementById('uploadSection');
        const previewSection = document.getElementById('previewSection');
        const comparisonContainer = document.getElementById('comparisonContainer');
        const imageCounter = document.getElementById('imageCounter');
        const cropBtn = document.getElementById('cropBtn');
        const applyCropBtn = document.getElementById('applyCropBtn');
        const cancelCropBtn = document.getElementById('cancelCropBtn');
        const rotateLeftBtn = document.getElementById('rotateLeftBtn');
        const rotateRightBtn = document.getElementById('rotateRightBtn');
        const filterIntensity = document.getElementById('filterIntensity');
        const intensityValue = document.getElementById('intensityValue');
        
        // Elementos de esc√°ner
        const scannerModal = document.getElementById('scannerModal');
        const closeScanner = document.getElementById('closeScanner');
        const scannerStatus = document.getElementById('scannerStatus');
        const printerList = document.getElementById('printerList');
        const refreshPrintersBtn = document.getElementById('refreshPrintersBtn');
        
        // Pasos del esc√°ner
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step1Content = document.getElementById('step1Content');
        const step2Content = document.getElementById('step2Content');
        const step3Content = document.getElementById('step3Content');
        const nextStep1Btn = document.getElementById('nextStep1Btn');
        const nextStep2Btn = document.getElementById('nextStep2Btn');
        const backStep2Btn = document.getElementById('backStep2Btn');
        const backStep3Btn = document.getElementById('backStep3Btn');
        const startScanBtn = document.getElementById('startScanBtn');
        
        // Configuraci√≥n del esc√°ner
        const documentSource = document.getElementById('documentSource');
        const scanQuality = document.getElementById('scanQuality');
        const colorFormat = document.getElementById('colorFormat');
        const documentSize = document.getElementById('documentSize');
        const selectedPrinterName = document.getElementById('selectedPrinterName');
        const step2Status = document.getElementById('step2Status');
        const step3Status = document.getElementById('step3Status');
        const scanConfigSummary = document.getElementById('scanConfigSummary');

        // Elementos de calidad PDF
        const qualityOptions = document.querySelectorAll('.quality-option');

        // Variables globales
        let images = [];
        let currentImageIndex = 0;
        let isCropping = false;
        let currentFilter = 'document';
        let cropArea = null;
        let pdfLayout = 'onePerPage';
        let isDragging = false;
        let dragHandle = null;
        let startX, startY, startWidth, startHeight, startLeft, startTop;
        let pdfQuality = 'high';
        let selectedPrinter = null;

        // Event listeners
        fileUploadOption.addEventListener('click', () => fileInput.click());
        cameraOption.addEventListener('click', () => cameraInput.click());
        scannerOption.addEventListener('click', openScanner);
        fileInput.addEventListener('change', handleFileSelect);
        cameraInput.addEventListener('change', handleCameraCapture);
        generateBtn.addEventListener('click', generatePDF);
        clearBtn.addEventListener('click', clearAll);
        prevBtn.addEventListener('click', showPreviousImage);
        nextBtn.addEventListener('click', showNextImage);
        applyToAllBtn.addEventListener('click', applyCurrentFilterToAll);
        filterIntensity.addEventListener('input', updateIntensityValue);
        filterIntensity.addEventListener('change', () => applyFilter(currentFilter));
        takePhotoBtn.addEventListener('click', () => cameraInput.click());
        scanMoreBtn.addEventListener('click', openScanner);
        
        // Event listeners de esc√°ner
        closeScanner.addEventListener('click', closeScannerModal);
        refreshPrintersBtn.addEventListener('click', loadNetworkPrinters);
        nextStep1Btn.addEventListener('click', goToStep2);
        nextStep2Btn.addEventListener('click', goToStep3);
        backStep2Btn.addEventListener('click', goToStep1);
        backStep3Btn.addEventListener('click', goToStep2);
        startScanBtn.addEventListener('click', startRealScanning);

        // Event listeners de calidad PDF
        qualityOptions.forEach(option => {
            option.addEventListener('click', function() {
                qualityOptions.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                pdfQuality = this.getAttribute('data-quality');
            });
        });

        // Configuraci√≥n de PDF
        onePerPageBtn.addEventListener('click', () => {
            onePerPageBtn.classList.add('active');
            twoPerPageBtn.classList.remove('active');
            pdfLayout = 'onePerPage';
        });
        
        twoPerPageBtn.addEventListener('click', () => {
            twoPerPageBtn.classList.add('active');
            onePerPageBtn.classList.remove('active');
            pdfLayout = 'twoPerPage';
        });
        
        // Filtros preconfigurados
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.getAttribute('data-filter');
                applyFilter(currentFilter);
            });
        });
        
        // Herramientas de recorte y rotaci√≥n
        cropBtn.addEventListener('click', activateCrop);
        applyCropBtn.addEventListener('click', applyCrop);
        cancelCropBtn.addEventListener('click', cancelCrop);
        rotateLeftBtn.addEventListener('click', () => rotateImage(-90));
        rotateRightBtn.addEventListener('click', () => rotateImage(90));

        function updateIntensityValue() {
            intensityValue.textContent = `${filterIntensity.value}/10`;
        }

        // Funci√≥n para manejar captura de c√°mara nativa
        function handleCameraCapture(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            const file = files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const imageData = {
                    src: e.target.result,
                    name: `foto_${new Date().getTime()}.jpg`,
                    enhancedSrc: e.target.result,
                    filter: 'document',
                    rotation: 0,
                    crop: null,
                    originalData: e.target.result,
                    source: 'camera'
                };
                
                images.push(imageData);
                
                if (images.length === 1) {
                    currentImageIndex = 0;
                    updateComparisonView();
                    applyFilter('document');
                }
                
                updatePreviewSection();
                
                alert('‚úÖ Foto capturada con c√°mara nativa\nüì± Calidad optimizada para m√≥vil');
            };
            
            reader.readAsDataURL(file);
            cameraInput.value = '';
        }

        // Funciones de esc√°ner MEJORADAS
        function openScanner() {
            scannerModal.style.display = 'flex';
            resetScannerSteps();
            loadNetworkPrinters();
        }

        function closeScannerModal() {
            scannerModal.style.display = 'none';
            selectedPrinter = null;
        }

        function resetScannerSteps() {
            // Resetear a paso 1
            [step1, step2, step3].forEach(step => step.classList.remove('active', 'completed'));
            [step1Content, step2Content, step3Content].forEach(content => content.classList.remove('active'));
            
            step1.classList.add('active');
            step1Content.classList.add('active');
            nextStep1Btn.disabled = true;
        }

        function goToStep2() {
            if (!selectedPrinter) return;
            
            step1.classList.remove('active');
            step1.classList.add('completed');
            step2.classList.add('active');
            
            step1Content.classList.remove('active');
            step2Content.classList.add('active');
            
            selectedPrinterName.textContent = selectedPrinter.name;
            step2Status.innerHTML = `Impresora seleccionada: <strong>${selectedPrinter.name}</strong>`;
        }

        function goToStep3() {
            step2.classList.remove('active');
            step2.classList.add('completed');
            step3.classList.add('active');
            
            step2Content.classList.remove('active');
            step3Content.classList.add('active');
            
            // Mostrar resumen de configuraci√≥n
            const sourceText = documentSource.value === 'flatbed' ? 'Platina de vidrio' : 'Alimentador autom√°tico';
            const qualityText = `${scanQuality.value} DPI`;
            const colorText = colorFormat.value === 'color' ? 'Color' : 
                            colorFormat.value === 'grayscale' ? 'Escala de grises' : 'Blanco y negro';
            const sizeText = documentSize.options[documentSize.selectedIndex].text;
            
            scanConfigSummary.innerHTML = `
                <strong>Resumen de configuraci√≥n:</strong><br>
                üìÑ Impresora: ${selectedPrinter.name}<br>
                üîß Fuente: ${sourceText}<br>
                üéØ Calidad: ${qualityText}<br>
                üé® Color: ${colorText}<br>
                üìè Tama√±o: ${sizeText}
            `;
        }

        function goToStep2() {
            step3.classList.remove('active');
            step2.classList.add('active');
            step3.classList.remove('completed');
            
            step3Content.classList.remove('active');
            step2Content.classList.add('active');
        }

        function goToStep1() {
            step2.classList.remove('active');
            step1.classList.add('active');
            step2.classList.remove('completed');
            
            step2Content.classList.remove('active');
            step1Content.classList.add('active');
        }

        // Cargar impresoras de red (simulaci√≥n realista)
        function loadNetworkPrinters() {
            printerList.innerHTML = '';
            scannerStatus.innerHTML = '<div class="loading"></div> Escaneando red en busca de impresoras...';
            nextStep1Btn.disabled = true;
            
            // Simular b√∫squeda en red
            setTimeout(() => {
                const networkPrinters = [
                    {
                        id: '1',
                        name: 'HP LaserJet Pro MFP M428fdw',
                        ip: '192.168.1.100',
                        status: 'En l√≠nea',
                        location: 'Oficina Principal - Red',
                        type: 'multifuncional',
                        features: ['escaneo', 'impresi√≥n', 'copia']
                    },
                    {
                        id: '2', 
                        name: 'Canon imageCLASS MF644Cdw',
                        ip: '192.168.1.101',
                        status: 'En l√≠nea', 
                        location: 'Sala de Reuniones - Red',
                        type: 'multifuncional',
                        features: ['escaneo', 'impresi√≥n', 'fax']
                    },
                    {
                        id: '3',
                        name: 'Epson WorkForce WF-2860',
                        ip: '192.168.1.102',
                        status: 'Conectada',
                        location: 'Recepci√≥n - Red',
                        type: 'multifuncional',
                        features: ['escaneo', 'impresi√≥n']
                    },
                    {
                        id: '4',
                        name: 'Brother MFC-L8900CDW',
                        ip: '192.168.1.103', 
                        status: 'Ocupada',
                        location: 'Departamento Contable - Red',
                        type: 'multifuncional',
                        features: ['escaneo', 'impresi√≥n', 'copia']
                    },
                    {
                        id: '5',
                        name: 'Xerox VersaLink C400',
                        ip: '192.168.1.104',
                        status: 'En l√≠nea',
                        location: 'Almac√©n - Red',
                        type: 'multifuncional',
                        features: ['escaneo', 'impresi√≥n']
                    }
                ];
                
                if (networkPrinters.length === 0) {
                    printerList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No se encontraron impresoras en la red</div>';
                    scannerStatus.innerHTML = '‚ùå No se encontraron impresoras en la red';
                } else {
                    networkPrinters.forEach(printer => {
                        const printerItem = document.createElement('div');
                        printerItem.className = 'printer-item';
                        printerItem.innerHTML = `
                            <div class="printer-name">${printer.name}</div>
                            <div class="printer-details">
                                üåê IP: ${printer.ip} | 
                                Estado: <span style="color: ${printer.status === 'En l√≠nea' ? '#28a745' : '#dc3545'}">${printer.status}</span> | 
                                Ubicaci√≥n: ${printer.location}
                            </div>
                        `;
                        
                        printerItem.addEventListener('click', () => {
                            document.querySelectorAll('.printer-item').forEach(item => {
                                item.classList.remove('selected');
                            });
                            printerItem.classList.add('selected');
                            selectedPrinter = printer;
                            nextStep1Btn.disabled = false;
                            scannerStatus.innerHTML = `‚úÖ <strong>${printer.name}</strong> seleccionada<br>IP: ${printer.ip} | Estado: ${printer.status}`;
                        });
                        
                        printerList.appendChild(printerItem);
                    });
                }
                
                scannerStatus.innerHTML = `üîç Se encontraron ${networkPrinters.length} impresoras en la red<br>Selecciona una para continuar`;
            }, 2500);
        }

        function startRealScanning() {
            const source = documentSource.value;
            const quality = scanQuality.value;
            const color = colorFormat.value;
            const size = documentSize.value;
            
            // Mostrar alerta con configuraci√≥n
            const sourceText = source === 'flatbed' ? 'Platina de vidrio' : 'Alimentador autom√°tico';
            const colorText = color === 'color' ? 'Color' : color === 'grayscale' ? 'Escala de grises' : 'Blanco y negro';
            const sizeText = documentSize.options[documentSize.selectedIndex].text;
            
            const configAlert = `‚öôÔ∏è Configuraci√≥n de escaneo:\n\n` +
                              `üñ®Ô∏è Impresora: ${selectedPrinter.name}\n` +
                              `üìÑ Fuente: ${sourceText}\n` +
                              `üéØ Calidad: ${quality} DPI\n` +
                              `üé® Color: ${colorText}\n` +
                              `üìè Tama√±o: ${sizeText}\n\n` +
                              `¬øIniciar escaneo con esta configuraci√≥n?`;
            
            if (confirm(configAlert)) {
                step3Status.innerHTML = '<div class="loading"></div> Conectando con la impresora...';
                
                setTimeout(() => {
                    step3Status.innerHTML = '<div class="loading"></div> Preparando esc√°ner...';
                    
                    setTimeout(() => {
                        step3Status.innerHTML = '<div class="loading"></div> Escaneando documento...';
                        
                        setTimeout(() => {
                            // Simular escaneo real
                            simulateRealScan(quality, color, size);
                        }, 3000);
                    }, 2000);
                }, 1500);
            }
        }

        function simulateRealScan(quality, color, size) {
            // Crear imagen de escaneo simulada
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Configurar tama√±o seg√∫n calidad
            let width, height;
            switch(size) {
                case 'letter':
                    width = 2550;
                    height = 3300;
                    break;
                case 'legal':
                    width = 2550;
                    height = 4200;
                    break;
                case 'a4':
                    width = 2480;
                    height = 3508;
                    break;
                default:
                    width = 2550;
                    height = 3300;
            }
            
            const dpi = parseInt(quality);
            const scale = dpi / 300;
            canvas.width = width * scale;
            canvas.height = height * scale;
            
            // Fondo de esc√°ner
            if (color === 'color') {
                ctx.fillStyle = '#f0f0f0';
            } else if (color === 'grayscale') {
                ctx.fillStyle = '#f5f5f5';
            } else {
                ctx.fillStyle = '#ffffff';
            }
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Contenido del documento escaneado
            let textColor;
            if (color === 'color') {
                textColor = '#2c3e50';
            } else if (color === 'grayscale') {
                textColor = '#4a4a4a';
            } else {
                textColor = '#000000';
            }
            
            ctx.fillStyle = textColor;
            const fontSize = 48 * scale;
            ctx.font = `bold ${fontSize}px 'Times New Roman'`;
            
            // T√≠tulo
            ctx.fillText('DOCUMENTO ESCANEADO', 100 * scale, 200 * scale);
            
            // Informaci√≥n del escaneo
            ctx.font = `${24 * scale}px Arial`;
            ctx.fillText(`Impresora: ${selectedPrinter.name}`, 100 * scale, 300 * scale);
            ctx.fillText(`Fecha: ${new Date().toLocaleDateString()}`, 100 * scale, 350 * scale);
            ctx.fillText(`Calidad: ${dpi} DPI`, 100 * scale, 400 * scale);
            ctx.fillText(`Color: ${color === 'color' ? 'Color' : color === 'grayscale' ? 'Escala de grises' : 'Blanco y negro'}`, 100 * scale, 450 * scale);
            
            // Contenido
            ctx.font = `${28 * scale}px Arial`;
            ctx.fillText('Documento escaneado desde:', 100 * scale, 600 * scale);
            ctx.fillText(selectedPrinter.name, 100 * scale, 650 * scale);
            ctx.fillText(`Configuraci√≥n: ${dpi} DPI, ${color}`, 100 * scale, 700 * scale);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.95);
            addImageFromScanner(imageData, `escaneo_${selectedPrinter.name}_${dpi}dpi`);
            
            step3Status.innerHTML = `‚úÖ Escaneo completado exitosamente\n` +
                                  `üñ®Ô∏è Desde: ${selectedPrinter.name}\n` +
                                  `üìä ${dpi} DPI | ${color === 'color' ? 'Color' : color === 'grayscale' ? 'Grises' : 'B/N'}\n` +
                                  `üíæ Documento agregado a la lista`;
            
            setTimeout(() => {
                closeScannerModal();
                alert('‚úÖ Documento escaneado correctamente\nüìÑ El documento ha sido agregado a tu lista de im√°genes');
            }, 2000);
        }

        function addImageFromScanner(imageData, scanInfo) {
            const imageDataObj = {
                src: imageData,
                name: `${scanInfo}_${new Date().getTime()}.jpg`,
                enhancedSrc: imageData,
                filter: 'document',
                rotation: 0,
                crop: null,
                source: 'scanner',
                originalData: imageData
            };
            
            images.push(imageDataObj);
            
            if (images.length === 1) {
                currentImageIndex = 0;
                updateComparisonView();
                applyFilter('document');
            }
            
            updatePreviewSection();
        }

        // ... (resto de las funciones se mantienen igual)

        // Manejar la selecci√≥n de archivos
        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            const filesToProcess = Math.min(files.length, 10);
            let loadedCount = 0;
            
            for (let i = 0; i < filesToProcess; i++) {
                const file = files[i];
                if (!file.type.match('image.*')) continue;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = {
                        src: e.target.result,
                        name: file.name,
                        enhancedSrc: e.target.result,
                        filter: 'document',
                        rotation: 0,
                        crop: null,
                        originalData: e.target.result
                    };
                    
                    images.push(imageData);
                    loadedCount++;
                    
                    if (loadedCount === filesToProcess) {
                        currentImageIndex = 0;
                        updateComparisonView();
                        applyFilter('document');
                        updatePreviewSection();
                    }
                };
                reader.readAsDataURL(file);
            }
            fileInput.value = '';
        }

        // Actualizar la vista de comparaci√≥n
        function updateComparisonView() {
            if (images.length === 0) return;
            
            const currentImage = images[currentImageIndex];
            comparisonContainer.innerHTML = `
                <div class="comparison-box">
                    <div class="comparison-header">Imagen Original</div>
                    <div class="comparison-image-container">
                        <span class="image-counter">${currentImageIndex + 1} / ${images.length}</span>
                        <img src="${currentImage.src}" alt="Original" class="comparison-image" id="originalImage">
                    </div>
                </div>
                <div class="comparison-box">
                    <div class="comparison-header">Imagen Mejorada</div>
                    <div class="comparison-image-container" id="enhancedContainer">
                        <img src="${currentImage.enhancedSrc}" alt="Mejorada" class="comparison-image" id="enhancedImage">
                        <div class="crop-overlay" id="cropOverlay"></div>
                    </div>
                </div>
            `;
            
            imageCounter.textContent = `Imagen ${currentImageIndex + 1} de ${images.length}`;
            prevBtn.disabled = currentImageIndex === 0;
            nextBtn.disabled = currentImageIndex === images.length - 1;
        }

        // Navegaci√≥n
        function showPreviousImage() {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                updateComparisonView();
                applyFilter(currentFilter);
            }
        }
        
        function showNextImage() {
            if (currentImageIndex < images.length - 1) {
                currentImageIndex++;
                updateComparisonView();
                applyFilter(currentFilter);
            }
        }

        // Actualizar la secci√≥n de vista previa
        function updatePreviewSection() {
            if (images.length === 0) {
                previewSection.style.display = 'none';
                uploadSection.style.display = 'block';
                takePhotoBtn.style.display = 'none';
                scanMoreBtn.style.display = 'none';
                return;
            }
            previewSection.style.display = 'block';
            uploadSection.style.display = 'none';
            takePhotoBtn.style.display = 'inline-block';
            scanMoreBtn.style.display = 'inline-block';
        }

        // Aplicar filtro
        function applyFilter(filterName) {
            if (images.length === 0) return;
            
            const currentImage = images[currentImageIndex];
            const img = new Image();
            img.src = currentImage.src;
            
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                if (currentImage.rotation !== 0) {
                    if (currentImage.rotation % 180 === 0) {
                        canvas.width = img.width;
                        canvas.height = img.height;
                    } else {
                        canvas.width = img.height;
                        canvas.height = img.width;
                    }
                    
                    ctx.save();
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate(currentImage.rotation * Math.PI / 180);
                    ctx.drawImage(img, -img.width / 2, -img.height / 2, img.width, img.height);
                    ctx.restore();
                } else {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                }
                
                let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                let data = imageData.data;
                
                const intensity = parseInt(filterIntensity.value) / 10;
                
                switch(filterName) {
                    case 'document':
                        applyEnhancedDocumentFilter(data, intensity);
                        break;
                    case 'aclarar':
                        applyModerateBrightnessFilter(data, intensity);
                        break;
                    case 'textoOscuro':
                        applyDarkerTextFilter(data, intensity);
                        break;
                    case 'contrast':
                        applyHighContrastFilter(data, intensity);
                        break;
                    default:
                        break;
                }
                
                if (filterName !== 'original') {
                    ctx.putImageData(imageData, 0, 0);
                }
                
                if (currentImage.crop) {
                    const cropCanvas = document.createElement('canvas');
                    const cropCtx = cropCanvas.getContext('2d');
                    cropCanvas.width = currentImage.crop.width;
                    cropCanvas.height = currentImage.crop.height;
                    
                    cropCtx.drawImage(
                        canvas, 
                        currentImage.crop.x, 
                        currentImage.crop.y, 
                        currentImage.crop.width, 
                        currentImage.crop.height,
                        0, 0, 
                        currentImage.crop.width, 
                        currentImage.crop.height
                    );
                    
                    currentImage.enhancedSrc = cropCanvas.toDataURL('image/jpeg', 0.9);
                } else {
                    currentImage.enhancedSrc = canvas.toDataURL('image/jpeg', 0.9);
                }
                
                currentImage.filter = filterName;
                updateComparisonView();
            };
        }

        // FILTROS (sin cambios)
        function applyEnhancedDocumentFilter(data, intensity) {
            let grayscale = [];
            for (let i = 0; i < data.length; i += 4) {
                const gray = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                grayscale.push(gray);
            }
            
            let threshold = 128;
            if (intensity > 0.5) {
                threshold = 128 - (intensity - 0.5) * 50;
            } else {
                threshold = 128 + (0.5 - intensity) * 50;
            }
            
            let grayIndex = 0;
            for (let i = 0; i < data.length; i += 4) {
                const gray = grayscale[grayIndex++];
                const adjustedThreshold = Math.max(50, Math.min(200, threshold));
                
                if (gray > adjustedThreshold) {
                    data[i] = data[i+1] = data[i+2] = 255;
                } else {
                    data[i] = data[i+1] = data[i+2] = 0;
                }
            }
        }
        
        function applyModerateBrightnessFilter(data, intensity) {
            const brightness = 1.0 + (intensity * 0.4);
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, data[i] * brightness);
                data[i+1] = Math.min(255, data[i+1] * brightness);
                data[i+2] = Math.min(255, data[i+2] * brightness);
            }
        }
        
        function applyDarkerTextFilter(data, intensity) {
            for (let i = 0; i < data.length; i += 4) {
                const gray = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                const threshold = 180 - (intensity * 40);
                if (gray > threshold) {
                    data[i] = data[i+1] = data[i+2] = 255;
                } else {
                    data[i] = data[i+1] = data[i+2] = 0;
                }
            }
        }
        
        function applyHighContrastFilter(data, intensity) {
            const contrast = 1.0 + (intensity * 2.0);
            const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.max(0, Math.min(255, factor * (data[i] - 128) + 128));
                data[i+1] = Math.max(0, Math.min(255, factor * (data[i+1] - 128) + 128));
                data[i+2] = Math.max(0, Math.min(255, factor * (data[i+2] - 128) + 128));
            }
        }

        // Aplicar filtro actual a todas las im√°genes
        function applyCurrentFilterToAll() {
            if (images.length === 0) return;
            
            images.forEach((image, index) => {
                if (index !== currentImageIndex) {
                    const tempImg = new Image();
                    tempImg.src = image.src;
                    
                    tempImg.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = tempImg.width;
                        canvas.height = tempImg.height;
                        ctx.drawImage(tempImg, 0, 0);
                        
                        let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        let data = imageData.data;
                        const intensity = parseInt(filterIntensity.value) / 10;
                        
                        switch(currentFilter) {
                            case 'document': applyEnhancedDocumentFilter(data, intensity); break;
                            case 'aclarar': applyModerateBrightnessFilter(data, intensity); break;
                            case 'textoOscuro': applyDarkerTextFilter(data, intensity); break;
                            case 'contrast': applyHighContrastFilter(data, intensity); break;
                        }
                        
                        ctx.putImageData(imageData, 0, 0);
                        image.enhancedSrc = canvas.toDataURL('image/jpeg', 0.9);
                        image.filter = currentFilter;
                    };
                }
            });
            
            alert(`Filtro aplicado a todas las ${images.length} im√°genes`);
        }

        // GENERAR PDF MEJORADO
        function generatePDF() {
            if (images.length === 0) {
                alert('Por favor, selecciona al menos una imagen.');
                return;
            }
            
            try {
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    compress: pdfQuality !== 'high'
                });
                
                const pageWidth = 210;
                const pageHeight = 297;
                
                let jpegQuality;
                switch(pdfQuality) {
                    case 'high':
                        jpegQuality = 1.0;
                        break;
                    case 'medium':
                        jpegQuality = 0.8;
                        break;
                    case 'low':
                        jpegQuality = 0.6;
                        break;
                }
                
                if (pdfLayout === 'onePerPage') {
                    images.forEach((image, index) => {
                        if (index > 0) pdf.addPage();
                        const imgSrc = image.originalData || image.enhancedSrc || image.src;
                        pdf.addImage(imgSrc, 'JPEG', 0, 0, pageWidth, pageHeight, undefined, 'FAST', 0, jpegQuality);
                    });
                } else {
                    for (let i = 0; i < images.length; i += 2) {
                        if (i > 0) pdf.addPage();
                        
                        const img1Src = images[i].originalData || images[i].enhancedSrc || images[i].src;
                        pdf.addImage(img1Src, 'JPEG', 0, 0, pageWidth, pageHeight / 2, undefined, 'FAST', 0, jpegQuality);
                        
                        if (i + 1 < images.length) {
                            const img2Src = images[i + 1].originalData || images[i + 1].enhancedSrc || images[i + 1].src;
                            pdf.addImage(img2Src, 'JPEG', 0, pageHeight / 2, pageWidth, pageHeight / 2, undefined, 'FAST', 0, jpegQuality);
                        }
                    }
                }
                
                pdf.save('documentos_mejorados.pdf');
                alert(`‚úÖ PDF generado correctamente con ${images.length} im√°genes\nüìä Calidad: ${pdfQuality === 'high' ? 'Alta' : pdfQuality === 'medium' ? 'Media' : 'B√°sica'}\nüìÑ Formato: ${pdfLayout === 'onePerPage' ? '1 por p√°gina' : '2 por p√°gina'}`);
            } catch (error) {
                console.error('Error:', error);
                alert('Error al generar PDF. Verifica que las im√°genes sean v√°lidas.');
            }
        }

        // Funciones de recorte (sin cambios)
        function activateCrop() {
            if (images.length === 0) return;
            isCropping = true;
            const overlay = document.getElementById('cropOverlay');
            const enhancedImg = document.getElementById('enhancedImage');
            if (!overlay || !enhancedImg) return;
            overlay.style.display = 'block';
            const containerRect = overlay.getBoundingClientRect();
            const cropWidth = containerRect.width * 0.8;
            const cropHeight = containerRect.height * 0.8;
            const cropX = (containerRect.width - cropWidth) / 2;
            const cropY = (containerRect.height - cropHeight) / 2;
            createCropArea(cropX, cropY, cropWidth, cropHeight);
            setupCropEvents();
        }
        
        // ... (resto de funciones de recorte se mantienen igual)

        function clearAll() {
            images = [];
            currentImageIndex = 0;
            isCropping = false;
            currentFilter = 'document';
            cropArea = null;
            filterIntensity.value = 5;
            intensityValue.textContent = '5/10';
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-filter="document"]').classList.add('active');
            updatePreviewSection();
        }

        // Inicializar
        updateIntensityValue();
    </script>
</body>
</html>