<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mejorador de Documentos Escaneados</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(to right, #1e3c72, #2a5298);
            color: white;
            padding: 25px;
            text-align: center;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .config-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .config-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .config-btn {
            background: white;
            border: 2px solid #1e3c72;
            color: #1e3c72;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .config-btn.active {
            background: #1e3c72;
            color: white;
        }

        .upload-section {
            background-color: #f8f9fa;
            border: 2px dashed #1e3c72;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            background-color: #eef2ff;
            border-color: #2a5298;
        }

        .upload-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .upload-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .upload-option:hover {
            border-color: #1e3c72;
            background: #f8f9fa;
        }

        .upload-option-icon {
            font-size: 40px;
            color: #1e3c72;
        }

        .upload-option-text {
            font-weight: 600;
            color: #1e3c72;
        }

        .upload-icon {
            font-size: 50px;
            color: #1e3c72;
            margin-bottom: 15px;
        }

        .upload-text {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(to right, #1e3c72, #2a5298);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 0.95rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(30, 60, 114, 0.3);
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 60, 114, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-success {
            background: linear-gradient(to right, #11998e, #38ef7d);
        }

        .btn-warning {
            background: linear-gradient(to right, #f46b45, #eea849);
        }

        .btn-danger {
            background: linear-gradient(to right, #ff416c, #ff4b2b);
        }

        .btn-info {
            background: linear-gradient(to right, #007bff, #0056b3);
        }

        .preview-section {
            display: none;
        }

        .preview-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #1e3c72;
            text-align: center;
        }

        .image-comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .comparison-box {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            background: white;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .comparison-header {
            background: #f8f9fa;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            border-bottom: 1px solid #eee;
            font-size: 1rem;
        }

        .comparison-image-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            min-height: 400px;
        }

        .comparison-image {
            width: 100%;
            height: 100%;
            max-height: 500px;
            object-fit: contain;
            display: block;
            padding: 10px;
        }

        .tools-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .filters-panel, .crop-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .panel-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #1e3c72;
            text-align: center;
        }

        .filter-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .filter-btn {
            background: white;
            border: 2px solid #1e3c72;
            color: #1e3c72;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-align: center;
        }

        .filter-btn:hover {
            background: #1e3c72;
            color: white;
        }

        .filter-btn.active {
            background: #1e3c72;
            color: white;
        }

        .crop-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .rotation-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .info-section {
            background-color: #eef2ff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .info-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #1e3c72;
        }

        .info-list {
            padding-left: 20px;
        }

        .info-list li {
            margin-bottom: 8px;
        }

        footer {
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
        }

        @media (max-width: 768px) {
            .image-comparison-container, .tools-section {
                grid-template-columns: 1fr;
            }
            
            .filter-buttons {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }

            .upload-options {
                flex-direction: column;
                align-items: center;
            }
        }

        /* Estilos para el recorte */
        .crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            cursor: crosshair;
            display: none;
            background: rgba(0,0,0,0.3);
        }

        .crop-area {
            position: absolute;
            border: 2px solid #ff0000;
            background: rgba(255, 0, 0, 0.1);
            cursor: move;
            box-sizing: border-box;
        }

        .crop-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ff0000;
            border: 2px solid white;
            border-radius: 50%;
        }

        .handle-tl { top: -6px; left: -6px; cursor: nw-resize; }
        .handle-tr { top: -6px; right: -6px; cursor: ne-resize; }
        .handle-bl { bottom: -6px; left: -6px; cursor: sw-resize; }
        .handle-br { bottom: -6px; right: -6px; cursor: se-resize; }

        .image-counter {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        .navigation-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        .crop-instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9rem;
            color: #856404;
        }

        .quality-control {
            margin-top: 15px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
        }

        .quality-slider {
            width: 100%;
            margin: 10px 0;
        }

        /* Estilos para la c√°mara */
        .camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .camera-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .camera-preview {
            width: 100%;
            max-width: 640px;
            border-radius: 10px;
            background: #000;
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }

        .close-camera {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .camera-flash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .flash-active {
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Mejorador de Documentos Escaneados</h1>
            <p class="subtitle">Filtros mejorados, recorte preciso, c√°mara y opciones de PDF</p>
        </header>
        
        <div class="main-content">
            <!-- Secci√≥n de configuraci√≥n -->
            <div class="config-section" id="configSection">
                <h3>Configuraci√≥n del PDF</h3>
                <p>Selecciona c√≥mo quieres organizar las im√°genes en el PDF:</p>
                <div class="config-options">
                    <button class="config-btn active" id="onePerPage">1 Imagen por P√°gina</button>
                    <button class="config-btn" id="twoPerPage">2 Im√°genes por P√°gina</button>
                </div>
            </div>

            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">üìÑ</div>
                <h2 class="upload-text">Sube tus documentos escaneados</h2>
                <p>Formatos: JPG, PNG, GIF - M√°ximo 10 im√°genes</p>
                
                <div class="upload-options">
                    <div class="upload-option" id="fileUploadOption">
                        <div class="upload-option-icon">üìÅ</div>
                        <div class="upload-option-text">Subir Archivos</div>
                    </div>
                    <div class="upload-option" id="cameraOption">
                        <div class="upload-option-icon">üì∑</div>
                        <div class="upload-option-text">Tomar Foto</div>
                    </div>
                </div>
                
                <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>
                <button class="btn" id="selectBtn" style="display: none;">Seleccionar Im√°genes</button>
            </div>
            
            <div class="preview-section" id="previewSection">
                <h2 class="preview-title">Mejora tus Documentos</h2>
                
                <div class="navigation-buttons">
                    <button class="btn" id="prevBtn">‚Üê Anterior</button>
                    <span id="imageCounter">Imagen 1 de 1</span>
                    <button class="btn" id="nextBtn">Siguiente ‚Üí</button>
                </div>
                
                <div class="image-comparison-container" id="comparisonContainer">
                    <!-- Se llenar√° din√°micamente con JavaScript -->
                </div>
                
                <div class="tools-section">
                    <div class="filters-panel">
                        <h3 class="panel-title">Filtros Preconfigurados</h3>
                        <div class="filter-buttons">
                            <button class="filter-btn" data-filter="original">Original</button>
                            <button class="filter-btn active" data-filter="document">Documento Mejorado</button>
                            <button class="filter-btn" data-filter="aclarar">Aclarar Imagen</button>
                            <button class="filter-btn" data-filter="textoOscuro">Texto M√°s Oscuro</button>
                            <button class="filter-btn" data-filter="contrast">Alto Contraste</button>
                            <button class="btn btn-success" id="applyToAllBtn">Aplicar a Todos</button>
                        </div>
                        
                        <div class="quality-control">
                            <label>Intensidad del Filtro:</label>
                            <input type="range" min="1" max="10" value="7" class="quality-slider" id="filterIntensity">
                            <span id="intensityValue">7/10</span>
                        </div>
                    </div>
                    
                    <div class="crop-panel">
                        <h3 class="panel-title">Herramientas de Recorte</h3>
                        <div class="crop-instructions">
                            üí° <strong>Instrucciones:</strong> Activa recorte, ajusta el √°rea roja (se mantiene dentro de la imagen) y aplica
                        </div>
                        <div class="crop-controls">
                            <button class="btn" id="cropBtn">Activar Recorte</button>
                            <button class="btn btn-success" id="applyCropBtn">Aplicar Recorte</button>
                            <button class="btn btn-danger" id="cancelCropBtn">Cancelar Recorte</button>
                        </div>
                        <div class="rotation-controls">
                            <button class="btn btn-warning" id="rotateLeftBtn">‚Ü∫ Girar Izquierda</button>
                            <button class="btn btn-warning" id="rotateRightBtn">‚Üª Girar Derecha</button>
                        </div>
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn" id="addMoreBtn">Agregar M√°s Im√°genes</button>
                    <button class="btn btn-info" id="takePhotoBtn">Tomar Otra Foto</button>
                    <button class="btn btn-success" id="generateBtn">Generar PDF Mejorado</button>
                    <button class="btn btn-danger" id="clearBtn">Limpiar Todo</button>
                </div>
            </div>
            
            <div class="info-section">
                <h3 class="info-title">Filtros Mejorados:</h3>
                <ul class="info-list">
                    <li><strong>Documento Mejorado:</strong> Fondo blanco puro, texto negro n√≠tido (recomendado)</li>
                    <li><strong>Aclarar Imagen:</strong> Aumenta el brillo general de la imagen</li>
                    <li><strong>Texto M√°s Oscuro:</strong> Enfocado en oscurecer texto que se ve muy claro</li>
                    <li><strong>Alto Contraste:</strong> M√°xima diferencia entre texto y fondo</li>
                    <li><strong>Control de Intensidad:</strong> Ajusta qu√© tan fuerte se aplica el filtro</li>
                </ul>
            </div>
        </div>
        
        <footer>
            <p>Mejorador de Documentos Escaneados &copy; 2023</p>
        </footer>
    </div>

    <!-- Modal para la c√°mara -->
    <div class="camera-modal" id="cameraModal">
        <div class="camera-container">
            <button class="close-camera" id="closeCamera">√ó</button>
            <video class="camera-preview" id="cameraPreview" autoplay playsinline></video>
            <canvas id="cameraCanvas" style="display: none;"></canvas>
            <div class="camera-flash" id="cameraFlash"></div>
            <div class="camera-controls">
                <button class="btn btn-danger" id="captureBtn">üì∏ Capturar</button>
                <button class="btn btn-warning" id="switchCameraBtn">üîÑ Cambiar C√°mara</button>
                <button class="btn" id="flashBtn">‚ö° Flash</button>
            </div>
        </div>
    </div>

    <script>
        // Inicializar jsPDF
        const { jsPDF } = window.jspdf;
        
        // Elementos DOM
        const fileInput = document.getElementById('fileInput');
        const selectBtn = document.getElementById('selectBtn');
        const addMoreBtn = document.getElementById('addMoreBtn');
        const takePhotoBtn = document.getElementById('takePhotoBtn');
        const generateBtn = document.getElementById('generateBtn');
        const clearBtn = document.getElementById('clearBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const applyToAllBtn = document.getElementById('applyToAllBtn');
        const onePerPageBtn = document.getElementById('onePerPage');
        const twoPerPageBtn = document.getElementById('twoPerPage');
        const uploadSection = document.getElementById('uploadSection');
        const previewSection = document.getElementById('previewSection');
        const comparisonContainer = document.getElementById('comparisonContainer');
        const imageCounter = document.getElementById('imageCounter');
        const cropBtn = document.getElementById('cropBtn');
        const applyCropBtn = document.getElementById('applyCropBtn');
        const cancelCropBtn = document.getElementById('cancelCropBtn');
        const rotateLeftBtn = document.getElementById('rotateLeftBtn');
        const rotateRightBtn = document.getElementById('rotateRightBtn');
        const filterIntensity = document.getElementById('filterIntensity');
        const intensityValue = document.getElementById('intensityValue');
        
        // Elementos de c√°mara
        const fileUploadOption = document.getElementById('fileUploadOption');
        const cameraOption = document.getElementById('cameraOption');
        const cameraModal = document.getElementById('cameraModal');
        const cameraPreview = document.getElementById('cameraPreview');
        const cameraCanvas = document.getElementById('cameraCanvas');
        const cameraFlash = document.getElementById('cameraFlash');
        const closeCamera = document.getElementById('closeCamera');
        const captureBtn = document.getElementById('captureBtn');
        const switchCameraBtn = document.getElementById('switchCameraBtn');
        const flashBtn = document.getElementById('flashBtn');

        // Variables globales
        let images = [];
        let currentImageIndex = 0;
        let isCropping = false;
        let currentFilter = 'document';
        let cropArea = null;
        let pdfLayout = 'onePerPage';
        let isDragging = false;
        let dragHandle = null;
        let startX, startY, startWidth, startHeight, startLeft, startTop;
        
        // Variables de c√°mara
        let stream = null;
        let currentFacingMode = 'environment'; // 'user' para frontal, 'environment' para trasera
        let flashOn = false;

        // Event listeners
        fileUploadOption.addEventListener('click', () => fileInput.click());
        cameraOption.addEventListener('click', openCamera);
        fileInput.addEventListener('change', handleFileSelect);
        generateBtn.addEventListener('click', generatePDF);
        clearBtn.addEventListener('click', clearAll);
        prevBtn.addEventListener('click', showPreviousImage);
        nextBtn.addEventListener('click', showNextImage);
        applyToAllBtn.addEventListener('click', applyCurrentFilterToAll);
        filterIntensity.addEventListener('input', updateIntensityValue);
        filterIntensity.addEventListener('change', () => applyFilter(currentFilter));
        takePhotoBtn.addEventListener('click', openCamera);
        
        // Event listeners de c√°mara
        closeCamera.addEventListener('click', closeCameraModal);
        captureBtn.addEventListener('click', capturePhoto);
        switchCameraBtn.addEventListener('click', switchCamera);
        flashBtn.addEventListener('click', toggleFlash);

        // Configuraci√≥n de PDF
        onePerPageBtn.addEventListener('click', () => {
            onePerPageBtn.classList.add('active');
            twoPerPageBtn.classList.remove('active');
            pdfLayout = 'onePerPage';
        });
        
        twoPerPageBtn.addEventListener('click', () => {
            twoPerPageBtn.classList.add('active');
            onePerPageBtn.classList.remove('active');
            pdfLayout = 'twoPerPage';
        });
        
        // Filtros preconfigurados
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.getAttribute('data-filter');
                applyFilter(currentFilter);
            });
        });
        
        // Herramientas de recorte y rotaci√≥n
        cropBtn.addEventListener('click', activateCrop);
        applyCropBtn.addEventListener('click', applyCrop);
        cancelCropBtn.addEventListener('click', cancelCrop);
        rotateLeftBtn.addEventListener('click', () => rotateImage(-90));
        rotateRightBtn.addEventListener('click', () => rotateImage(90));

        function updateIntensityValue() {
            intensityValue.textContent = `${filterIntensity.value}/10`;
        }

        // Funci√≥n para abrir la c√°mara
        async function openCamera() {
            try {
                cameraModal.style.display = 'flex';
                
                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                cameraPreview.srcObject = stream;
                
            } catch (error) {
                console.error('Error al acceder a la c√°mara:', error);
                alert('No se pudo acceder a la c√°mara. Aseg√∫rate de permitir el acceso a la c√°mara.');
                closeCameraModal();
            }
        }

        // Funci√≥n para cerrar la c√°mara
        function closeCameraModal() {
            cameraModal.style.display = 'none';
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        // Funci√≥n para capturar foto
        function capturePhoto() {
            if (!stream) return;
            
            // Efecto de flash
            cameraFlash.classList.add('flash-active');
            setTimeout(() => {
                cameraFlash.classList.remove('flash-active');
            }, 300);
            
            // Capturar imagen
            const context = cameraCanvas.getContext('2d');
            cameraCanvas.width = cameraPreview.videoWidth;
            cameraCanvas.height = cameraPreview.videoHeight;
            context.drawImage(cameraPreview, 0, 0);
            
            // Convertir a data URL y agregar a las im√°genes
            const imageData = cameraCanvas.toDataURL('image/jpeg');
            addImageFromCamera(imageData);
            
            // Cerrar c√°mara despu√©s de capturar
            setTimeout(() => {
                closeCameraModal();
            }, 500);
        }

        // Funci√≥n para cambiar de c√°mara
        async function switchCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            await openCamera();
        }

        // Funci√≥n para toggle flash
        function toggleFlash() {
            flashOn = !flashOn;
            flashBtn.textContent = flashOn ? '‚ö° Flash On' : '‚ö° Flash';
            flashBtn.style.background = flashOn ? 
                'linear-gradient(to right, #ffd700, #ffed4e)' : 
                'linear-gradient(to right, #1e3c72, #2a5298)';
        }

        // Agregar imagen desde la c√°mara
        function addImageFromCamera(imageData) {
            const imageDataObj = {
                src: imageData,
                name: `foto_${new Date().getTime()}.jpg`,
                enhancedSrc: imageData,
                filter: 'document',
                rotation: 0,
                crop: null
            };
            
            images.push(imageDataObj);
            
            if (images.length === 1) {
                currentImageIndex = 0;
                updateComparisonView();
                applyFilter('document');
            }
            
            updatePreviewSection();
        }

        // Manejar la selecci√≥n de archivos
        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            const filesToProcess = Math.min(files.length, 10);
            let loadedCount = 0;
            
            for (let i = 0; i < filesToProcess; i++) {
                const file = files[i];
                if (!file.type.match('image.*')) continue;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = {
                        src: e.target.result,
                        name: file.name,
                        enhancedSrc: e.target.result,
                        filter: 'document',
                        rotation: 0,
                        crop: null
                    };
                    
                    images.push(imageData);
                    loadedCount++;
                    
                    if (loadedCount === filesToProcess) {
                        currentImageIndex = 0;
                        updateComparisonView();
                        applyFilter('document');
                        updatePreviewSection();
                    }
                };
                reader.readAsDataURL(file);
            }
            fileInput.value = '';
        }
        
        // Actualizar la vista de comparaci√≥n
        function updateComparisonView() {
            if (images.length === 0) return;
            
            const currentImage = images[currentImageIndex];
            comparisonContainer.innerHTML = `
                <div class="comparison-box">
                    <div class="comparison-header">Imagen Original</div>
                    <div class="comparison-image-container">
                        <span class="image-counter">${currentImageIndex + 1} / ${images.length}</span>
                        <img src="${currentImage.src}" alt="Original" class="comparison-image" id="originalImage">
                    </div>
                </div>
                <div class="comparison-box">
                    <div class="comparison-header">Imagen Mejorada</div>
                    <div class="comparison-image-container" id="enhancedContainer">
                        <img src="${currentImage.enhancedSrc}" alt="Mejorada" class="comparison-image" id="enhancedImage">
                        <div class="crop-overlay" id="cropOverlay"></div>
                    </div>
                </div>
            `;
            
            imageCounter.textContent = `Imagen ${currentImageIndex + 1} de ${images.length}`;
            prevBtn.disabled = currentImageIndex === 0;
            nextBtn.disabled = currentImageIndex === images.length - 1;
        }
        
        // Navegaci√≥n
        function showPreviousImage() {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                updateComparisonView();
                applyFilter(currentFilter);
            }
        }
        
        function showNextImage() {
            if (currentImageIndex < images.length - 1) {
                currentImageIndex++;
                updateComparisonView();
                applyFilter(currentFilter);
            }
        }
        
        // Actualizar la secci√≥n de vista previa
        function updatePreviewSection() {
            if (images.length === 0) {
                previewSection.style.display = 'none';
                uploadSection.style.display = 'block';
                takePhotoBtn.style.display = 'none';
                return;
            }
            previewSection.style.display = 'block';
            uploadSection.style.display = 'none';
            takePhotoBtn.style.display = 'inline-block';
        }
        
        // Aplicar filtro preconfigurado (MEJORADO CON FILTRO ACLARAR)
        function applyFilter(filterName) {
            if (images.length === 0) return;
            
            const currentImage = images[currentImageIndex];
            const img = new Image();
            img.src = currentImage.src;
            
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Manejar rotaci√≥n
                if (currentImage.rotation !== 0) {
                    if (currentImage.rotation % 180 === 0) {
                        canvas.width = img.width;
                        canvas.height = img.height;
                    } else {
                        canvas.width = img.height;
                        canvas.height = img.width;
                    }
                    
                    ctx.save();
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate(currentImage.rotation * Math.PI / 180);
                    ctx.drawImage(img, -img.width / 2, -img.height / 2, img.width, img.height);
                    ctx.restore();
                } else {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                }
                
                let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                let data = imageData.data;
                
                // Obtener intensidad del filtro
                const intensity = parseInt(filterIntensity.value) / 10;
                
                // Aplicar filtro mejorado
                switch(filterName) {
                    case 'document':
                        applyEnhancedDocumentFilter(data, intensity);
                        break;
                    case 'aclarar':
                        applyBrightnessFilter(data, intensity);
                        break;
                    case 'textoOscuro':
                        applyDarkerTextFilter(data, intensity);
                        break;
                    case 'contrast':
                        applyHighContrastFilter(data, intensity);
                        break;
                    default:
                        // Original - no hacer nada
                        break;
                }
                
                if (filterName !== 'original') {
                    ctx.putImageData(imageData, 0, 0);
                }
                
                // Aplicar recorte si existe
                if (currentImage.crop) {
                    const cropCanvas = document.createElement('canvas');
                    const cropCtx = cropCanvas.getContext('2d');
                    cropCanvas.width = currentImage.crop.width;
                    cropCanvas.height = currentImage.crop.height;
                    
                    cropCtx.drawImage(
                        canvas, 
                        currentImage.crop.x, 
                        currentImage.crop.y, 
                        currentImage.crop.width, 
                        currentImage.crop.height,
                        0, 0, 
                        currentImage.crop.width, 
                        currentImage.crop.height
                    );
                    
                    currentImage.enhancedSrc = cropCanvas.toDataURL();
                } else {
                    currentImage.enhancedSrc = canvas.toDataURL();
                }
                
                currentImage.filter = filterName;
                updateComparisonView();
            };
        }
        
        // FILTRO DOCUMENTO MEJORADO CON CONTROL DE INTENSIDAD
        function applyEnhancedDocumentFilter(data, intensity) {
            let grayscale = [];
            for (let i = 0; i < data.length; i += 4) {
                const gray = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                grayscale.push(gray);
            }
            
            let threshold = 128;
            if (intensity > 0.5) {
                threshold = 128 - (intensity - 0.5) * 50;
            } else {
                threshold = 128 + (0.5 - intensity) * 50;
            }
            
            let grayIndex = 0;
            for (let i = 0; i < data.length; i += 4) {
                const gray = grayscale[grayIndex++];
                const adjustedThreshold = Math.max(50, Math.min(200, threshold));
                
                if (gray > adjustedThreshold) {
                    data[i] = data[i+1] = data[i+2] = 255;
                } else {
                    data[i] = data[i+1] = data[i+2] = 0;
                }
            }
        }
        
        // NUEVO FILTRO: ACLARAR IMAGEN
        function applyBrightnessFilter(data, intensity) {
            const brightness = 1.0 + (intensity * 0.8); // 1.0 a 1.8
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, data[i] * brightness);
                data[i+1] = Math.min(255, data[i+1] * brightness);
                data[i+2] = Math.min(255, data[i+2] * brightness);
            }
        }
        
        // FILTRO TEXTO M√ÅS OSCURO
        function applyDarkerTextFilter(data, intensity) {
            for (let i = 0; i < data.length; i += 4) {
                const gray = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                const threshold = 180 - (intensity * 40);
                
                if (gray > threshold) {
                    data[i] = data[i+1] = data[i+2] = 255;
                } else {
                    data[i] = data[i+1] = data[i+2] = 0;
                }
            }
        }
        
        // FILTRO ALTO CONTRASTE
        function applyHighContrastFilter(data, intensity) {
            const contrast = 1.0 + (intensity * 2.0);
            const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
            
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.max(0, Math.min(255, factor * (data[i] - 128) + 128));
                data[i+1] = Math.max(0, Math.min(255, factor * (data[i+1] - 128) + 128));
                data[i+2] = Math.max(0, Math.min(255, factor * (data[i+2] - 128) + 128));
            }
        }
        
        // Aplicar filtro actual a todas las im√°genes
        function applyCurrentFilterToAll() {
            if (images.length === 0) return;
            
            images.forEach((image, index) => {
                if (index !== currentImageIndex) {
                    const tempImg = new Image();
                    tempImg.src = image.src;
                    
                    tempImg.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = tempImg.width;
                        canvas.height = tempImg.height;
                        ctx.drawImage(tempImg, 0, 0);
                        
                        let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        let data = imageData.data;
                        const intensity = parseInt(filterIntensity.value) / 10;
                        
                        switch(currentFilter) {
                            case 'document': applyEnhancedDocumentFilter(data, intensity); break;
                            case 'aclarar': applyBrightnessFilter(data, intensity); break;
                            case 'textoOscuro': applyDarkerTextFilter(data, intensity); break;
                            case 'contrast': applyHighContrastFilter(data, intensity); break;
                        }
                        
                        ctx.putImageData(imageData, 0, 0);
                        image.enhancedSrc = canvas.toDataURL();
                        image.filter = currentFilter;
                    };
                }
            });
            
            alert(`Filtro aplicado a todas las ${images.length} im√°genes`);
        }
        
        // RECORTE MEJORADO (NO SE SALE DE LOS L√çMITES)
        function activateCrop() {
            if (images.length === 0) return;
            
            isCropping = true;
            const overlay = document.getElementById('cropOverlay');
            const enhancedImg = document.getElementById('enhancedImage');
            
            if (!overlay || !enhancedImg) return;
            
            overlay.style.display = 'block';
            
            const containerRect = overlay.getBoundingClientRect();
            const cropWidth = containerRect.width * 0.8;
            const cropHeight = containerRect.height * 0.8;
            const cropX = (containerRect.width - cropWidth) / 2;
            const cropY = (containerRect.height - cropHeight) / 2;
            
            createCropArea(cropX, cropY, cropWidth, cropHeight);
            setupCropEvents();
        }
        
        function createCropArea(x, y, width, height) {
            const overlay = document.getElementById('cropOverlay');
            if (!overlay) return;
            
            overlay.innerHTML = '';
            
            cropArea = document.createElement('div');
            cropArea.className = 'crop-area';
            cropArea.style.left = x + 'px';
            cropArea.style.top = y + 'px';
            cropArea.style.width = width + 'px';
            cropArea.style.height = height + 'px';
            
            const handles = ['tl', 'tr', 'bl', 'br'];
            handles.forEach(handle => {
                const handleEl = document.createElement('div');
                handleEl.className = `crop-handle handle-${handle}`;
                handleEl.dataset.handle = handle;
                cropArea.appendChild(handleEl);
            });
            
            overlay.appendChild(cropArea);
        }
        
        function setupCropEvents() {
            if (!cropArea) return;
            
            const handles = cropArea.querySelectorAll('.crop-handle');
            handles.forEach(handle => {
                handle.addEventListener('mousedown', startResize);
            });
            
            cropArea.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', doDragResize);
            document.addEventListener('mouseup', stopDragResize);
        }
        
        function startResize(e) {
            e.stopPropagation();
            e.preventDefault();
            isDragging = true;
            dragHandle = e.target.dataset.handle;
            const rect = cropArea.getBoundingClientRect();
            startX = e.clientX;
            startY = e.clientY;
            startWidth = rect.width;
            startHeight = rect.height;
            startLeft = rect.left;
            startTop = rect.top;
        }
        
        function startDrag(e) {
            if (e.target.classList.contains('crop-handle')) return;
            e.preventDefault();
            isDragging = true;
            dragHandle = 'move';
            const rect = cropArea.getBoundingClientRect();
            startX = e.clientX;
            startY = e.clientY;
            startLeft = rect.left;
            startTop = rect.top;
        }
        
        function doDragResize(e) {
            if (!isDragging || !cropArea) return;
            
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            const overlay = document.getElementById('cropOverlay');
            const overlayRect = overlay.getBoundingClientRect();
            
            const minX = overlayRect.left;
            const minY = overlayRect.top;
            const maxX = overlayRect.right;
            const maxY = overlayRect.bottom;
            
            if (dragHandle === 'move') {
                let newLeft = startLeft + dx;
                let newTop = startTop + dy;
                
                newLeft = Math.max(minX, Math.min(newLeft, maxX - cropArea.offsetWidth));
                newTop = Math.max(minY, Math.min(newTop, maxY - cropArea.offsetHeight));
                
                cropArea.style.left = (newLeft - minX) + 'px';
                cropArea.style.top = (newTop - minY) + 'px';
            } else {
                let newWidth = startWidth;
                let newHeight = startHeight;
                let newLeft = startLeft;
                let newTop = startTop;
                
                switch(dragHandle) {
                    case 'tr':
                        newWidth = Math.max(50, startWidth + dx);
                        newHeight = Math.max(50, startHeight - dy);
                        newTop = Math.max(minY, startTop + dy);
                        break;
                    case 'tl':
                        newWidth = Math.max(50, startWidth - dx);
                        newHeight = Math.max(50, startHeight - dy);
                        newLeft = Math.max(minX, startLeft + dx);
                        newTop = Math.max(minY, startTop + dy);
                        break;
                    case 'br':
                        newWidth = Math.max(50, startWidth + dx);
                        newHeight = Math.max(50, startHeight + dy);
                        break;
                    case 'bl':
                        newWidth = Math.max(50, startWidth - dx);
                        newHeight = Math.max(50, startHeight + dy);
                        newLeft = Math.max(minX, startLeft + dx);
                        break;
                }
                
                newLeft = Math.max(minX, newLeft);
                newTop = Math.max(minY, newTop);
                newWidth = Math.min(newWidth, maxX - newLeft);
                newHeight = Math.min(newHeight, maxY - newTop);
                
                cropArea.style.left = (newLeft - minX) + 'px';
                cropArea.style.top = (newTop - minY) + 'px';
                cropArea.style.width = newWidth + 'px';
                cropArea.style.height = newHeight + 'px';
            }
        }
        
        function stopDragResize() {
            isDragging = false;
            dragHandle = null;
        }
        
        function applyCrop() {
            if (!isCropping || !cropArea) return;
            
            const currentImage = images[currentImageIndex];
            const enhancedImg = document.getElementById('enhancedImage');
            
            if (!enhancedImg) return;
            
            const imgRect = enhancedImg.getBoundingClientRect();
            const cropRect = cropArea.getBoundingClientRect();
            
            const scaleX = enhancedImg.naturalWidth / imgRect.width;
            const scaleY = enhancedImg.naturalHeight / imgRect.height;
            
            currentImage.crop = {
                x: (cropRect.left - imgRect.left) * scaleX,
                y: (cropRect.top - imgRect.top) * scaleY,
                width: cropRect.width * scaleX,
                height: cropRect.height * scaleY
            };
            
            applyFilter(currentFilter);
            isCropping = false;
            document.getElementById('cropOverlay').style.display = 'none';
            alert('Recorte aplicado correctamente');
        }
        
        function cancelCrop() {
            isCropping = false;
            const overlay = document.getElementById('cropOverlay');
            if (overlay) {
                overlay.style.display = 'none';
                overlay.innerHTML = '';
            }
            cropArea = null;
            isDragging = false;
            dragHandle = null;
        }
        
        function rotateImage(degrees) {
            if (images.length === 0) return;
            const currentImage = images[currentImageIndex];
            currentImage.rotation = (currentImage.rotation + degrees) % 360;
            applyFilter(currentFilter);
        }
        
        function clearAll() {
            images = [];
            currentImageIndex = 0;
            isCropping = false;
            currentFilter = 'document';
            cropArea = null;
            filterIntensity.value = 7;
            intensityValue.textContent = '7/10';
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-filter="document"]').classList.add('active');
            updatePreviewSection();
        }
        
        // GENERAR PDF
        function generatePDF() {
            if (images.length === 0) {
                alert('Por favor, selecciona al menos una imagen.');
                return;
            }
            
            try {
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const pageWidth = 210;
                const pageHeight = 297;
                
                if (pdfLayout === 'onePerPage') {
                    images.forEach((image, index) => {
                        if (index > 0) pdf.addPage();
                        const imgSrc = image.enhancedSrc || image.src;
                        pdf.addImage(imgSrc, 'JPEG', 0, 0, pageWidth, pageHeight);
                    });
                } else {
                    for (let i = 0; i < images.length; i += 2) {
                        if (i > 0) pdf.addPage();
                        
                        const img1Src = images[i].enhancedSrc || images[i].src;
                        pdf.addImage(img1Src, 'JPEG', 0, 0, pageWidth, pageHeight / 2);
                        
                        if (i + 1 < images.length) {
                            const img2Src = images[i + 1].enhancedSrc || images[i + 1].src;
                            pdf.addImage(img2Src, 'JPEG', 0, pageHeight / 2, pageWidth, pageHeight / 2);
                        }
                    }
                }
                
                pdf.save('documentos_mejorados.pdf');
                alert(`PDF generado correctamente con ${images.length} im√°genes (${pdfLayout === 'onePerPage' ? '1 por p√°gina' : '2 por p√°gina'})`);
            } catch (error) {
                console.error('Error:', error);
                alert('Error al generar PDF. Verifica que las im√°genes sean v√°lidas.');
            }
        }

        // Inicializar valor de intensidad
        updateIntensityValue();
    </script>
</body>
</html>