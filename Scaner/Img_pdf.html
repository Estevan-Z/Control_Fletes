<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mejorador de Documentos Escaneados</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        header {
            background: linear-gradient(to right, #1e3c72, #2a5298);
            color: white;
            padding: 25px;
            text-align: center;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .config-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .config-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .config-btn {
            background: white;
            border: 2px solid #1e3c72;
            color: #1e3c72;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .config-btn.active {
            background: #1e3c72;
            color: white;
        }

        .upload-section {
            background-color: #f8f9fa;
            border: 2px dashed #1e3c72;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            background-color: #eef2ff;
            border-color: #2a5298;
        }

        .upload-options {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .upload-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .upload-option:hover {
            border-color: #1e3c72;
            background: #f8f9fa;
        }

        .upload-option-icon {
            font-size: 40px;
            color: #1e3c72;
        }

        .upload-option-text {
            font-weight: 600;
            color: #1e3c72;
            text-align: center;
        }

        .upload-icon {
            font-size: 50px;
            color: #1e3c72;
            margin-bottom: 15px;
        }

        .upload-text {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(to right, #1e3c72, #2a5298);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 0.95rem;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(30, 60, 114, 0.3);
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 60, 114, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-success {
            background: linear-gradient(to right, #11998e, #38ef7d);
        }

        .btn-warning {
            background: linear-gradient(to right, #f46b45, #eea849);
        }

        .btn-danger {
            background: linear-gradient(to right, #ff416c, #ff4b2b);
        }

        .btn-info {
            background: linear-gradient(to right, #007bff, #0056b3);
        }

        .btn-secondary {
            background: linear-gradient(to right, #6c757d, #495057);
        }

        .preview-section {
            display: none;
        }

        .preview-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: #1e3c72;
            text-align: center;
        }

        .image-comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .comparison-box {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            background: white;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .comparison-header {
            background: #f8f9fa;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            border-bottom: 1px solid #eee;
            font-size: 1rem;
        }

        .comparison-image-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            min-height: 400px;
        }

        .comparison-image {
            width: 100%;
            height: 100%;
            max-height: 500px;
            object-fit: contain;
            display: block;
            padding: 10px;
        }

        .tools-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .filters-panel, .crop-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .panel-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #1e3c72;
            text-align: center;
        }

        .filter-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .filter-btn {
            background: white;
            border: 2px solid #1e3c72;
            color: #1e3c72;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-align: center;
        }

        .filter-btn:hover {
            background: #1e3c72;
            color: white;
        }

        .filter-btn.active {
            background: #1e3c72;
            color: white;
        }

        .crop-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .rotation-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }

        .actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        footer {
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
        }

        @media (max-width: 768px) {
            .image-comparison-container, .tools-section {
                grid-template-columns: 1fr;
            }
            
            .filter-buttons {
                grid-template-columns: 1fr;
            }
            
            .actions {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }

            .upload-options {
                flex-direction: column;
                align-items: center;
            }
        }

        /* Estilos para el recorte CORREGIDO */
        .crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            cursor: crosshair;
            display: none;
            background: rgba(0,0,0,0.3);
        }

        .crop-area {
            position: absolute;
            border: 2px solid #ff0000;
            background: rgba(255, 0, 0, 0.1);
            cursor: move;
            box-sizing: border-box;
        }

        .crop-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ff0000;
            border: 2px solid white;
            border-radius: 50%;
        }

        .handle-tl { top: -6px; left: -6px; cursor: nw-resize; }
        .handle-tr { top: -6px; right: -6px; cursor: ne-resize; }
        .handle-bl { bottom: -6px; left: -6px; cursor: sw-resize; }
        .handle-br { bottom: -6px; right: -6px; cursor: se-resize; }

        .image-counter {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        .navigation-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }

        .crop-instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9rem;
            color: #856404;
        }

        .quality-control {
            margin-top: 15px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
        }

        .quality-slider {
            width: 100%;
            margin: 10px 0;
        }

        /* Nuevos estilos para mejoras */
        .crop-history-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .history-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .history-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .image-info {
            text-align: center;
            margin: 10px 0;
            color: #666;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Mejorador de Documentos Escaneados</h1>
            <p class="subtitle">Sube, mejora y genera PDFs de alta calidad</p>
        </header>
        
        <div class="main-content">
            <!-- Secci√≥n de configuraci√≥n -->
            <div class="config-section" id="configSection">
                <h3>Configuraci√≥n del PDF</h3>
                <p>Selecciona c√≥mo quieres organizar las im√°genes en el PDF:</p>
                <div class="config-options">
                    <button class="config-btn active" id="onePerPage">1 Imagen por P√°gina</button>
                    <button class="config-btn" id="twoPerPage">2 Im√°genes por P√°gina</button>
                </div>

                <div class="pdf-quality">
                    <label>Calidad del PDF:</label>
                    <div class="quality-options">
                        <div class="quality-option selected" data-quality="high">Alta Calidad</div>
                        <div class="quality-option" data-quality="medium">Calidad Media</div>
                        <div class="quality-option" data-quality="low">Tama√±o Peque√±o</div>
                    </div>
                </div>
            </div>

            <div class="upload-section" id="uploadSection">
                <div class="upload-icon">üìÑ</div>
                <h2 class="upload-text">Sube o captura tus documentos</h2>
                <p>M√∫ltiples formas de obtener tus im√°genes - Sin l√≠mite de im√°genes</p>
                
                <div class="upload-options">
                    <div class="upload-option" id="fileUploadOption">
                        <div class="upload-option-icon">üìÅ</div>
                        <div class="upload-option-text">Subir Archivos</div>
                    </div>
                    <div class="upload-option" id="cameraOption">
                        <div class="upload-option-icon">üì∑</div>
                        <div class="upload-option-text">C√°mara Nativa</div>
                    </div>
                </div>
                
                <input type="file" id="fileInput" class="file-input" accept="image/*" multiple>
                <input type="file" id="cameraInput" class="file-input" accept="image/*" capture="environment">
            </div>
            
            <div class="preview-section" id="previewSection">
                <h2 class="preview-title">Mejora tus Documentos</h2>
                
                <div class="image-info" id="imageInfo">
                    <!-- Informaci√≥n de im√°genes cargadas -->
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn" id="prevBtn">‚Üê Anterior</button>
                    <span id="imageCounter">Imagen 1 de 1</span>
                    <button class="btn" id="nextBtn">Siguiente ‚Üí</button>
                </div>
                
                <div class="image-comparison-container" id="comparisonContainer">
                    <!-- Se llenar√° din√°micamente con JavaScript -->
                </div>
                
                <div class="tools-section">
                    <div class="filters-panel">
                        <h3 class="panel-title">Filtros Preconfigurados</h3>
                        <div class="filter-buttons">
                            <button class="filter-btn" data-filter="original">Original</button>
                            <button class="filter-btn active" data-filter="document">Documento Mejorado</button>
                            <button class="filter-btn" data-filter="aclarar">Aclarar Moderado</button>
                            <button class="filter-btn" data-filter="textoOscuro">Texto M√°s Oscuro</button>
                            <button class="filter-btn" data-filter="contrast">Alto Contraste</button>
                            <button class="btn btn-success" id="applyToAllBtn">Aplicar a Todos</button>
                        </div>
                        
                        <div class="quality-control">
                            <label>Intensidad del Filtro:</label>
                            <input type="range" min="1" max="10" value="5" class="quality-slider" id="filterIntensity">
                            <span id="intensityValue">5/10</span>
                        </div>
                    </div>
                    
                    <div class="crop-panel">
                        <h3 class="panel-title">Herramientas de Recorte</h3>
                        <div class="crop-instructions">
                            üí° <strong>Instrucciones:</strong> Activa recorte, ajusta el √°rea roja EXACTAMENTE donde quieres recortar y aplica
                        </div>
                        <div class="crop-controls">
                            <button class="btn" id="cropBtn">Activar Recorte</button>
                            <button class="btn btn-success" id="applyCropBtn">Aplicar Recorte</button>
                            <button class="btn btn-danger" id="cancelCropBtn">Cancelar Recorte</button>
                        </div>
                        <div class="crop-history-controls">
                            <button class="history-btn" id="undoCropBtn" disabled>‚Ü∂ Deshacer Recorte</button>
                            <button class="history-btn" id="resetCropBtn">üîÑ Restaurar Original</button>
                        </div>
                        <div class="rotation-controls">
                            <button class="btn btn-warning" id="rotateLeftBtn">‚Ü∫ Girar Izquierda</button>
                            <button class="btn btn-warning" id="rotateRightBtn">‚Üª Girar Derecha</button>
                        </div>
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn" id="addMoreBtn">Agregar M√°s Im√°genes</button>
                    <button class="btn btn-info" id="takePhotoBtn">Usar C√°mara</button>
                    <button class="btn btn-success" id="generateBtn">Generar PDF Mejorado</button>
                    <button class="btn btn-danger" id="clearBtn">Limpiar Todo</button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Mejorador de Documentos Escaneados &copy; 2023</p>
        </footer>
    </div>

    <script>
        // Inicializar jsPDF
        const { jsPDF } = window.jspdf;
        
        // Elementos DOM
        const fileInput = document.getElementById('fileInput');
        const cameraInput = document.getElementById('cameraInput');
        const addMoreBtn = document.getElementById('addMoreBtn');
        const takePhotoBtn = document.getElementById('takePhotoBtn');
        const generateBtn = document.getElementById('generateBtn');
        const clearBtn = document.getElementById('clearBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const applyToAllBtn = document.getElementById('applyToAllBtn');
        const onePerPageBtn = document.getElementById('onePerPage');
        const twoPerPageBtn = document.getElementById('twoPerPage');
        const uploadSection = document.getElementById('uploadSection');
        const previewSection = document.getElementById('previewSection');
        const comparisonContainer = document.getElementById('comparisonContainer');
        const imageCounter = document.getElementById('imageCounter');
        const imageInfo = document.getElementById('imageInfo');
        const cropBtn = document.getElementById('cropBtn');
        const applyCropBtn = document.getElementById('applyCropBtn');
        const cancelCropBtn = document.getElementById('cancelCropBtn');
        const rotateLeftBtn = document.getElementById('rotateLeftBtn');
        const rotateRightBtn = document.getElementById('rotateRightBtn');
        const filterIntensity = document.getElementById('filterIntensity');
        const intensityValue = document.getElementById('intensityValue');
        const undoCropBtn = document.getElementById('undoCropBtn');
        const resetCropBtn = document.getElementById('resetCropBtn');
        
        // Elementos de calidad PDF
        const qualityOptions = document.querySelectorAll('.quality-option');

        // Variables globales
        let images = [];
        let currentImageIndex = 0;
        let isCropping = false;
        let currentFilter = 'document';
        let cropArea = null;
        let pdfLayout = 'onePerPage';
        let isDragging = false;
        let dragHandle = null;
        let startX, startY, startWidth, startHeight, startLeft, startTop;
        let pdfQuality = 'high';
        
        // Variables para el recorte CORREGIDO
        let cropStartX, cropStartY, cropEndX, cropEndY;
        let isDrawingCrop = false;

        // Event listeners
        fileUploadOption.addEventListener('click', () => fileInput.click());
        cameraOption.addEventListener('click', () => cameraInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        cameraInput.addEventListener('change', handleCameraCapture);
        generateBtn.addEventListener('click', generatePDF);
        clearBtn.addEventListener('click', clearAll);
        prevBtn.addEventListener('click', showPreviousImage);
        nextBtn.addEventListener('click', showNextImage);
        applyToAllBtn.addEventListener('click', applyCurrentFilterToAll);
        filterIntensity.addEventListener('input', updateIntensityValue);
        filterIntensity.addEventListener('change', () => applyFilter(currentFilter));
        takePhotoBtn.addEventListener('click', () => cameraInput.click());
        addMoreBtn.addEventListener('click', () => fileInput.click());
        
        // Event listeners de calidad PDF
        qualityOptions.forEach(option => {
            option.addEventListener('click', function() {
                qualityOptions.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                pdfQuality = this.getAttribute('data-quality');
            });
        });

        // Configuraci√≥n de PDF
        onePerPageBtn.addEventListener('click', () => {
            onePerPageBtn.classList.add('active');
            twoPerPageBtn.classList.remove('active');
            pdfLayout = 'onePerPage';
        });
        
        twoPerPageBtn.addEventListener('click', () => {
            twoPerPageBtn.classList.add('active');
            onePerPageBtn.classList.remove('active');
            pdfLayout = 'twoPerPage';
        });
        
        // Filtros preconfigurados
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.getAttribute('data-filter');
                applyFilter(currentFilter);
            });
        });
        
        // Herramientas de recorte y rotaci√≥n CORREGIDAS
        cropBtn.addEventListener('click', activateCrop);
        applyCropBtn.addEventListener('click', applyCrop);
        cancelCropBtn.addEventListener('click', cancelCrop);
        rotateLeftBtn.addEventListener('click', () => rotateImage(-90));
        rotateRightBtn.addEventListener('click', () => rotateImage(90));
        undoCropBtn.addEventListener('click', undoCrop);
        resetCropBtn.addEventListener('click', resetCrop);

        function updateIntensityValue() {
            intensityValue.textContent = `${filterIntensity.value}/10`;
        }

        // Funci√≥n para manejar captura de c√°mara nativa
        function handleCameraCapture(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            const file = files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const imageData = {
                    src: e.target.result,
                    name: `foto_${new Date().getTime()}.jpg`,
                    enhancedSrc: e.target.result,
                    filter: 'document',
                    rotation: 0,
                    crop: null,
                    originalData: e.target.result,
                    source: 'camera',
                    cropHistory: []
                };
                
                images.push(imageData);
                
                if (images.length === 1) {
                    currentImageIndex = 0;
                    updateComparisonView();
                    applyFilter('document');
                }
                
                updatePreviewSection();
                
                alert('‚úÖ Foto capturada con c√°mara nativa\nüì± Calidad optimizada para m√≥vil');
            };
            
            reader.readAsDataURL(file);
            cameraInput.value = '';
        }

        // Manejar la selecci√≥n de archivos - SIN L√çMITE
        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            let loadedCount = 0;
            const totalFiles = files.length;
            
            for (let i = 0; i < totalFiles; i++) {
                const file = files[i];
                if (!file.type.match('image.*')) continue;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = {
                        src: e.target.result,
                        name: file.name,
                        enhancedSrc: e.target.result,
                        filter: 'document',
                        rotation: 0,
                        crop: null,
                        originalData: e.target.result,
                        cropHistory: []
                    };
                    
                    images.push(imageData);
                    loadedCount++;
                    
                    if (loadedCount === totalFiles) {
                        currentImageIndex = images.length - 1;
                        updateComparisonView();
                        applyFilter('document');
                        updatePreviewSection();
                        alert(`‚úÖ ${loadedCount} imagen(es) agregada(s) correctamente\nüìä Total: ${images.length} im√°genes`);
                    }
                };
                reader.readAsDataURL(file);
            }
            fileInput.value = '';
        }

        // Actualizar la vista de comparaci√≥n
        function updateComparisonView() {
            if (images.length === 0) return;
            
            const currentImage = images[currentImageIndex];
            comparisonContainer.innerHTML = `
                <div class="comparison-box">
                    <div class="comparison-header">Imagen Original</div>
                    <div class="comparison-image-container">
                        <span class="image-counter">${currentImageIndex + 1} / ${images.length}</span>
                        <img src="${currentImage.src}" alt="Original" class="comparison-image" id="originalImage">
                    </div>
                </div>
                <div class="comparison-box">
                    <div class="comparison-header">Imagen Mejorada</div>
                    <div class="comparison-image-container" id="enhancedContainer">
                        <img src="${currentImage.enhancedSrc}" alt="Mejorada" class="comparison-image" id="enhancedImage">
                        <div class="crop-overlay" id="cropOverlay"></div>
                    </div>
                </div>
            `;
            
            imageCounter.textContent = `Imagen ${currentImageIndex + 1} de ${images.length}`;
            imageInfo.textContent = `üìä ${images.length} im√°genes cargadas | üíæ Tama√±o total: ${calculateTotalSize()} MB`;
            prevBtn.disabled = currentImageIndex === 0;
            nextBtn.disabled = currentImageIndex === images.length - 1;
            
            // Actualizar estado de botones de historial
            updateCropHistoryButtons();
        }

        // Calcular tama√±o total de las im√°genes
        function calculateTotalSize() {
            let totalSize = 0;
            images.forEach(img => {
                // Estimaci√≥n aproximada del tama√±o (base64)
                const base64 = img.src.split(',')[1];
                const sizeInBytes = base64.length * (3/4);
                totalSize += sizeInBytes;
            });
            return (totalSize / (1024 * 1024)).toFixed(2);
        }

        // Navegaci√≥n
        function showPreviousImage() {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                updateComparisonView();
                applyFilter(currentFilter);
            }
        }
        
        function showNextImage() {
            if (currentImageIndex < images.length - 1) {
                currentImageIndex++;
                updateComparisonView();
                applyFilter(currentFilter);
            }
        }

        // Actualizar la secci√≥n de vista previa
        function updatePreviewSection() {
            if (images.length === 0) {
                previewSection.style.display = 'none';
                uploadSection.style.display = 'block';
                takePhotoBtn.style.display = 'none';
                addMoreBtn.style.display = 'none';
                return;
            }
            previewSection.style.display = 'block';
            uploadSection.style.display = 'none';
            takePhotoBtn.style.display = 'inline-block';
            addMoreBtn.style.display = 'inline-block';
        }

        // Aplicar filtro
        function applyFilter(filterName) {
            if (images.length === 0) return;
            
            const currentImage = images[currentImageIndex];
            const img = new Image();
            img.src = currentImage.src;
            
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                if (currentImage.rotation !== 0) {
                    if (currentImage.rotation % 180 === 0) {
                        canvas.width = img.width;
                        canvas.height = img.height;
                    } else {
                        canvas.width = img.height;
                        canvas.height = img.width;
                    }
                    
                    ctx.save();
                    ctx.translate(canvas.width / 2, canvas.height / 2);
                    ctx.rotate(currentImage.rotation * Math.PI / 180);
                    ctx.drawImage(img, -img.width / 2, -img.height / 2, img.width, img.height);
                    ctx.restore();
                } else {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                }
                
                let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                let data = imageData.data;
                
                const intensity = parseInt(filterIntensity.value) / 10;
                
                switch(filterName) {
                    case 'document':
                        applyEnhancedDocumentFilter(data, intensity);
                        break;
                    case 'aclarar':
                        applyModerateBrightnessFilter(data, intensity);
                        break;
                    case 'textoOscuro':
                        applyDarkerTextFilter(data, intensity);
                        break;
                    case 'contrast':
                        applyHighContrastFilter(data, intensity);
                        break;
                    default:
                        break;
                }
                
                if (filterName !== 'original') {
                    ctx.putImageData(imageData, 0, 0);
                }
                
                // APLICAR RECORTE CORREGIDO
                if (currentImage.crop) {
                    const cropCanvas = document.createElement('canvas');
                    const cropCtx = cropCanvas.getContext('2d');
                    
                    // Usar las coordenadas EXACTAS del recorte
                    cropCanvas.width = currentImage.crop.width;
                    cropCanvas.height = currentImage.crop.height;
                    
                    cropCtx.drawImage(
                        canvas, 
                        currentImage.crop.x, 
                        currentImage.crop.y, 
                        currentImage.crop.width, 
                        currentImage.crop.height,
                        0, 0, 
                        currentImage.crop.width, 
                        currentImage.crop.height
                    );
                    
                    currentImage.enhancedSrc = cropCanvas.toDataURL('image/jpeg', 0.9);
                } else {
                    currentImage.enhancedSrc = canvas.toDataURL('image/jpeg', 0.9);
                }
                
                currentImage.filter = filterName;
                updateComparisonView();
            };
        }

        // FILTROS
        function applyEnhancedDocumentFilter(data, intensity) {
            let grayscale = [];
            for (let i = 0; i < data.length; i += 4) {
                const gray = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                grayscale.push(gray);
            }
            
            let threshold = 128;
            if (intensity > 0.5) {
                threshold = 128 - (intensity - 0.5) * 50;
            } else {
                threshold = 128 + (0.5 - intensity) * 50;
            }
            
            let grayIndex = 0;
            for (let i = 0; i < data.length; i += 4) {
                const gray = grayscale[grayIndex++];
                const adjustedThreshold = Math.max(50, Math.min(200, threshold));
                
                if (gray > adjustedThreshold) {
                    data[i] = data[i+1] = data[i+2] = 255;
                } else {
                    data[i] = data[i+1] = data[i+2] = 0;
                }
            }
        }
        
        function applyModerateBrightnessFilter(data, intensity) {
            const brightness = 1.0 + (intensity * 0.4);
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.min(255, data[i] * brightness);
                data[i+1] = Math.min(255, data[i+1] * brightness);
                data[i+2] = Math.min(255, data[i+2] * brightness);
            }
        }
        
        function applyDarkerTextFilter(data, intensity) {
            for (let i = 0; i < data.length; i += 4) {
                const gray = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                const threshold = 180 - (intensity * 40);
                if (gray > threshold) {
                    data[i] = data[i+1] = data[i+2] = 255;
                } else {
                    data[i] = data[i+1] = data[i+2] = 0;
                }
            }
        }
        
        function applyHighContrastFilter(data, intensity) {
            const contrast = 1.0 + (intensity * 2.0);
            const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.max(0, Math.min(255, factor * (data[i] - 128) + 128));
                data[i+1] = Math.max(0, Math.min(255, factor * (data[i+1] - 128) + 128));
                data[i+2] = Math.max(0, Math.min(255, factor * (data[i+2] - 128) + 128));
            }
        }

        // Aplicar filtro actual a todas las im√°genes
        function applyCurrentFilterToAll() {
            if (images.length === 0) return;
            
            images.forEach((image, index) => {
                if (index !== currentImageIndex) {
                    const tempImg = new Image();
                    tempImg.src = image.src;
                    
                    tempImg.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = tempImg.width;
                        canvas.height = tempImg.height;
                        ctx.drawImage(tempImg, 0, 0);
                        
                        let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        let data = imageData.data;
                        const intensity = parseInt(filterIntensity.value) / 10;
                        
                        switch(currentFilter) {
                            case 'document': applyEnhancedDocumentFilter(data, intensity); break;
                            case 'aclarar': applyModerateBrightnessFilter(data, intensity); break;
                            case 'textoOscuro': applyDarkerTextFilter(data, intensity); break;
                            case 'contrast': applyHighContrastFilter(data, intensity); break;
                        }
                        
                        ctx.putImageData(imageData, 0, 0);
                        image.enhancedSrc = canvas.toDataURL('image/jpeg', 0.9);
                        image.filter = currentFilter;
                    };
                }
            });
            
            alert(`Filtro aplicado a todas las ${images.length} im√°genes`);
        }

        // GENERAR PDF MEJORADO - IM√ÅGENES HORIZONTALES
        function generatePDF() {
            if (images.length === 0) {
                alert('Por favor, selecciona al menos una imagen.');
                return;
            }
            
            try {
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4',
                    compress: pdfQuality !== 'high'
                });
                
                const pageWidth = 297;
                const pageHeight = 210;
                
                let jpegQuality;
                switch(pdfQuality) {
                    case 'high':
                        jpegQuality = 1.0;
                        break;
                    case 'medium':
                        jpegQuality = 0.8;
                        break;
                    case 'low':
                        jpegQuality = 0.6;
                        break;
                }
                
                if (pdfLayout === 'onePerPage') {
                    images.forEach((image, index) => {
                        if (index > 0) pdf.addPage();
                        const imgSrc = image.enhancedSrc || image.src;
                        pdf.addImage(imgSrc, 'JPEG', 10, 10, pageWidth - 20, pageHeight - 20, undefined, 'FAST', 0, jpegQuality);
                    });
                } else {
                    for (let i = 0; i < images.length; i += 2) {
                        if (i > 0) pdf.addPage();
                        
                        const img1Src = images[i].enhancedSrc || images[i].src;
                        pdf.addImage(img1Src, 'JPEG', 10, 10, pageWidth - 20, (pageHeight - 30) / 2, undefined, 'FAST', 0, jpegQuality);
                        
                        if (i + 1 < images.length) {
                            const img2Src = images[i + 1].enhancedSrc || images[i + 1].src;
                            pdf.addImage(img2Src, 'JPEG', 10, (pageHeight - 30) / 2 + 15, pageWidth - 20, (pageHeight - 30) / 2, undefined, 'FAST', 0, jpegQuality);
                        }
                    }
                }
                
                pdf.save('documentos_mejorados.pdf');
                alert(`‚úÖ PDF generado correctamente con ${images.length} im√°genes\nüìä Calidad: ${pdfQuality === 'high' ? 'Alta' : pdfQuality === 'medium' ? 'Media' : 'B√°sica'}\nüìÑ Formato: ${pdfLayout === 'onePerPage' ? '1 por p√°gina' : '2 por p√°gina'}\nüîÑ Orientaci√≥n: Horizontal`);
            } catch (error) {
                console.error('Error:', error);
                alert('Error al generar PDF. Verifica que las im√°genes sean v√°lidas.');
            }
        }

        // FUNCIONES DE RECORTE CORREGIDAS - RECORTE PRECISO
        function activateCrop() {
            if (images.length === 0) return;
            isCropping = true;
            const overlay = document.getElementById('cropOverlay');
            const enhancedImg = document.getElementById('enhancedImage');
            if (!overlay || !enhancedImg) return;
            
            overlay.style.display = 'block';
            
            // Limpiar √°rea de recorte existente
            const existingCrop = overlay.querySelector('.crop-area');
            if (existingCrop) {
                existingCrop.remove();
            }
            
            // Configurar eventos para dibujar el √°rea de recorte
            setupCropDrawing(overlay, enhancedImg);
        }
        
        function setupCropDrawing(overlay, enhancedImg) {
            isDrawingCrop = false;
            
            overlay.onmousedown = function(e) {
                isDrawingCrop = true;
                const rect = overlay.getBoundingClientRect();
                cropStartX = e.clientX - rect.left;
                cropStartY = e.clientY - rect.top;
                
                // Crear √°rea de recorte
                createCropArea(cropStartX, cropStartY, 0, 0);
            };
            
            overlay.onmousemove = function(e) {
                if (!isDrawingCrop) return;
                
                const rect = overlay.getBoundingClientRect();
                cropEndX = e.clientX - rect.left;
                cropEndY = e.clientY - rect.top;
                
                // Actualizar √°rea de recorte
                updateCropArea(cropStartX, cropStartY, cropEndX, cropEndY);
            };
            
            overlay.onmouseup = function() {
                isDrawingCrop = false;
            };
        }
        
        function createCropArea(x, y, width, height) {
            const overlay = document.getElementById('cropOverlay');
            
            // Limpiar √°rea existente
            const existingCrop = overlay.querySelector('.crop-area');
            if (existingCrop) {
                existingCrop.remove();
            }
            
            cropArea = document.createElement('div');
            cropArea.className = 'crop-area';
            cropArea.style.left = x + 'px';
            cropArea.style.top = y + 'px';
            cropArea.style.width = Math.abs(width) + 'px';
            cropArea.style.height = Math.abs(height) + 'px';
            
            // Agregar manijas de redimensionamiento
            const handles = ['tl', 'tr', 'bl', 'br'];
            handles.forEach(handle => {
                const handleEl = document.createElement('div');
                handleEl.className = `crop-handle handle-${handle}`;
                cropArea.appendChild(handleEl);
            });
            
            overlay.appendChild(cropArea);
            
            // Configurar eventos para las manijas
            setupCropHandles();
        }
        
        function updateCropArea(startX, startY, endX, endY) {
            if (!cropArea) return;
            
            const x = Math.min(startX, endX);
            const y = Math.min(startY, endY);
            const width = Math.abs(endX - startX);
            const height = Math.abs(endY - startY);
            
            cropArea.style.left = x + 'px';
            cropArea.style.top = y + 'px';
            cropArea.style.width = width + 'px';
            cropArea.style.height = height + 'px';
        }
        
        function setupCropHandles() {
            if (!cropArea) return;
            
            const handles = cropArea.querySelectorAll('.crop-handle');
            handles.forEach(handle => {
                handle.addEventListener('mousedown', startResize);
            });
            
            // Evento para mover el √°rea completa
            cropArea.addEventListener('mousedown', startDrag);
        }
        
        function startDrag(e) {
            if (e.target.classList.contains('crop-handle')) return;
            
            e.preventDefault();
            isDragging = true;
            dragHandle = null;
            
            const overlay = document.getElementById('cropOverlay');
            const rect = overlay.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
            startLeft = parseInt(cropArea.style.left);
            startTop = parseInt(cropArea.style.top);
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', stopDrag);
        }
        
        function startResize(e) {
            e.preventDefault();
            e.stopPropagation();
            isDragging = true;
            dragHandle = e.target.className.split(' ')[1].split('-')[1];
            
            const overlay = document.getElementById('cropOverlay');
            const rect = overlay.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
            startLeft = parseInt(cropArea.style.left);
            startTop = parseInt(cropArea.style.top);
            startWidth = parseInt(cropArea.style.width);
            startHeight = parseInt(cropArea.style.height);
            
            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopDrag);
        }
        
        function drag(e) {
            if (!isDragging || dragHandle) return;
            e.preventDefault();
            
            const overlay = document.getElementById('cropOverlay');
            const rect = overlay.getBoundingClientRect();
            const newX = e.clientX - rect.left - startX + startLeft;
            const newY = e.clientY - rect.top - startY + startTop;
            
            // Limitar el movimiento dentro del √°rea de la imagen
            const maxX = rect.width - parseInt(cropArea.style.width);
            const maxY = rect.height - parseInt(cropArea.style.height);
            
            cropArea.style.left = Math.max(0, Math.min(maxX, newX)) + 'px';
            cropArea.style.top = Math.max(0, Math.min(maxY, newY)) + 'px';
        }
        
        function resize(e) {
            if (!isDragging || !dragHandle) return;
            e.preventDefault();
            
            const overlay = document.getElementById('cropOverlay');
            const rect = overlay.getBoundingClientRect();
            const deltaX = e.clientX - rect.left - startX;
            const deltaY = e.clientY - rect.top - startY;
            
            let newLeft = startLeft;
            let newTop = startTop;
            let newWidth = startWidth;
            let newHeight = startHeight;
            
            // Ajustar seg√∫n la manija utilizada
            if (dragHandle.includes('r')) {
                newWidth = Math.max(10, startWidth + deltaX);
            }
            if (dragHandle.includes('b')) {
                newHeight = Math.max(10, startHeight + deltaY);
            }
            if (dragHandle.includes('l')) {
                newWidth = Math.max(10, startWidth - deltaX);
                newLeft = startLeft + deltaX;
            }
            if (dragHandle.includes('t')) {
                newHeight = Math.max(10, startHeight - deltaY);
                newTop = startTop + deltaY;
            }
            
            // Limitar el tama√±o dentro del √°rea de la imagen
            const maxWidth = rect.width - newLeft;
            const maxHeight = rect.height - newTop;
            
            newWidth = Math.min(newWidth, maxWidth);
            newHeight = Math.min(newHeight, maxHeight);
            newLeft = Math.max(0, newLeft);
            newTop = Math.max(0, newTop);
            
            cropArea.style.left = newLeft + 'px';
            cropArea.style.top = newTop + 'px';
            cropArea.style.width = newWidth + 'px';
            cropArea.style.height = newHeight + 'px';
        }
        
        function stopDrag() {
            isDragging = false;
            dragHandle = null;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', stopDrag);
            document.removeEventListener('mousemove', resize);
        }
        
        function applyCrop() {
            if (!isCropping || !cropArea || images.length === 0) return;
            
            const currentImage = images[currentImageIndex];
            const overlay = document.getElementById('cropOverlay');
            const enhancedImg = document.getElementById('enhancedImage');
            
            if (!overlay || !enhancedImg) return;
            
            const imgRect = enhancedImg.getBoundingClientRect();
            const overlayRect = overlay.getBoundingClientRect();
            
            // Calcular proporciones EXACTAS
            const scaleX = enhancedImg.naturalWidth / imgRect.width;
            const scaleY = enhancedImg.naturalHeight / imgRect.height;
            
            // Calcular coordenadas de recorte en la imagen original
            const cropX = parseInt(cropArea.style.left) * scaleX;
            const cropY = parseInt(cropArea.style.top) * scaleY;
            const cropWidth = parseInt(cropArea.style.width) * scaleX;
            const cropHeight = parseInt(cropArea.style.height) * scaleY;
            
            // Asegurar que el recorte est√© dentro de los l√≠mites de la imagen
            const boundedCropX = Math.max(0, Math.min(enhancedImg.naturalWidth - cropWidth, cropX));
            const boundedCropY = Math.max(0, Math.min(enhancedImg.naturalHeight - cropHeight, cropY));
            const boundedCropWidth = Math.min(cropWidth, enhancedImg.naturalWidth - boundedCropX);
            const boundedCropHeight = Math.min(cropHeight, enhancedImg.naturalHeight - boundedCropY);
            
            // Guardar en el historial antes de aplicar
            if (!currentImage.cropHistory) currentImage.cropHistory = [];
            currentImage.cropHistory.push({
                crop: JSON.parse(JSON.stringify(currentImage.crop)), // Copia profunda
                index: currentImage.cropHistory.length
            });
            
            // Limitar el historial a 10 elementos
            if (currentImage.cropHistory.length > 10) {
                currentImage.cropHistory.shift();
            }
            
            // Guardar informaci√≥n de recorte EXACTA
            currentImage.crop = {
                x: Math.round(boundedCropX),
                y: Math.round(boundedCropY),
                width: Math.round(boundedCropWidth),
                height: Math.round(boundedCropHeight)
            };
            
            console.log('Recorte aplicado:', currentImage.crop);
            
            // Aplicar el recorte
            applyFilter(currentFilter);
            
            // Desactivar modo recorte
            cancelCrop();
            
            // Actualizar botones de historial
            updateCropHistoryButtons();
            
            alert(`‚úÖ Recorte aplicado correctamente\nüìè √Årea: ${Math.round(boundedCropWidth)}x${Math.round(boundedCropHeight)} p√≠xeles`);
        }
        
        function cancelCrop() {
            isCropping = false;
            isDrawingCrop = false;
            const overlay = document.getElementById('cropOverlay');
            if (overlay) {
                overlay.style.display = 'none';
                overlay.onmousedown = null;
                overlay.onmousemove = null;
                overlay.onmouseup = null;
                
                const cropArea = overlay.querySelector('.crop-area');
                if (cropArea) {
                    cropArea.remove();
                }
            }
        }
        
        // FUNCIONES DE HISTORIAL DE RECORTE
        function undoCrop() {
            const currentImage = images[currentImageIndex];
            if (!currentImage.cropHistory || currentImage.cropHistory.length === 0) return;
            
            const lastCrop = currentImage.cropHistory.pop();
            currentImage.crop = lastCrop.crop;
            
            // Aplicar el filtro actual para actualizar la vista
            applyFilter(currentFilter);
            
            // Actualizar botones de historial
            updateCropHistoryButtons();
            
            alert('‚Ü∂ Recorte deshecho');
        }
        
        function resetCrop() {
            const currentImage = images[currentImageIndex];
            currentImage.crop = null;
            currentImage.cropHistory = [];
            
            // Aplicar el filtro actual para actualizar la vista
            applyFilter(currentFilter);
            
            // Actualizar botones de historial
            updateCropHistoryButtons();
            
            alert('üîÑ Imagen restaurada a su estado original');
        }
        
        function updateCropHistoryButtons() {
            const currentImage = images[currentImageIndex];
            const hasHistory = currentImage.cropHistory && currentImage.cropHistory.length > 0;
            const hasCrop = currentImage.crop !== null;
            
            undoCropBtn.disabled = !hasHistory;
            resetCropBtn.disabled = !hasCrop;
        }
        
        function rotateImage(degrees) {
            if (images.length === 0) return;
            
            const currentImage = images[currentImageIndex];
            currentImage.rotation = (currentImage.rotation + degrees) % 360;
            
            // Aplicar el filtro actual para actualizar la vista
            applyFilter(currentFilter);
        }

        function clearAll() {
            if (images.length === 0) return;
            
            if (confirm(`¬øEst√°s seguro de que quieres eliminar todas las ${images.length} im√°genes?`)) {
                images = [];
                currentImageIndex = 0;
                isCropping = false;
                currentFilter = 'document';
                cropArea = null;
                filterIntensity.value = 5;
                intensityValue.textContent = '5/10';
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                document.querySelector('[data-filter="document"]').classList.add('active');
                updatePreviewSection();
                alert('üóëÔ∏è Todas las im√°genes han sido eliminadas');
            }
        }

        // Inicializar
        updateIntensityValue();
    </script>
</body>
</html>